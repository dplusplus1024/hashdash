<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1920, height=1080">
  <title>TELEHASH // LIVE</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #060e1f;
      --panel: #081b4a;
      --border: #1a3a6e;
      --text: #e6edf3;
      --text-dim: #8ba3c7;
      --accent: #58a6ff;
      --accent-bright: #79c0ff;
      --green: #3fb950;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      width: 1920px;
      height: 1080px;
      background: var(--bg);
      overflow: hidden;
      font-family: 'JetBrains Mono', monospace;
      color: var(--text);
    }

    .container {
      width: 1920px;
      height: 1080px;
      display: grid;
      grid-template-columns: 1fr 380px;
      grid-template-rows: 1fr auto;
      padding: 16px;
      gap: 16px;
    }

    /* Video Section */
    .video-section {
      grid-column: 1;
      grid-row: 1;
      background: #000;
      position: relative;
      border: 1px solid var(--border);
    }

    .video-placeholder {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .live-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      background: #da3633;
      padding: 4px 10px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1px;
    }

    .live-dot {
      width: 6px;
      height: 6px;
      background: white;
      border-radius: 50%;
      animation: blink 1s ease-in-out infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Dashboard */
    .dashboard {
      grid-column: 2;
      grid-row: 1;
      background: var(--panel);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 20px;
      gap: 20px;
      overflow: hidden;
    }

    /* Logo */
    .logo {
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
      text-align: center;
    }

    .logo-img {
      height: 44px;
      width: auto;
    }

    /* Stats grid */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .stat {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-subtext {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: -2px;
      max-width: 160px;
      white-space: nowrap;
      overflow: hidden;
      mask-image: linear-gradient(to right, black 70%, transparent 100%);
      -webkit-mask-image: linear-gradient(to right, black 70%, transparent 100%);
    }

    .stat-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text);
    }

    .stat-value:empty::before {
      content: '—';
      visibility: hidden;
    }

    .stat-subtext:empty::before {
      content: '—';
      visibility: hidden;
    }

    .stat-value .unit {
      font-size: 14px;
      font-weight: 400;
      color: var(--text-dim);
      margin-left: 8px;
    }

    /* Single row stat */
    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-top: 1px solid var(--border);
    }

    .stat-row .stat-label {
      font-size: 10px;
    }

    .stat-row .stat-value {
      font-size: 16px;
    }

    /* Section */
    .section {
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .section-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
      text-align: center;
    }

    /* QR codes */
    .qr-row {
      display: flex;
      gap: 24px;
      justify-content: center;
    }

    .qr-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .qr-item:first-child {
      padding-right: 24px;
      border-right: 1px solid var(--border);
    }

    .qr-code {
      width: 76px;
      height: 76px;
      background: white;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px;
    }

    .qr-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .qr-pattern {
      width: 56px;
      height: 56px;
      background: repeating-conic-gradient(#000 0% 25%, #fff 0% 50%) 50% / 8px 8px;
    }

    .qr-label {
      font-size: 13px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Donate hashrate */
    .donate-box {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 12px 14px;
    }

    .donate-url {
      font-size: 15.5px;
      color: var(--accent);
      word-break: break-all;
      margin-bottom: 8px;
    }

    .donate-row {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      margin-top: 10px;
    }

    .donate-hint {
      display: flex;
      flex-direction: column;
      gap: 0px;
      padding-right: 25px;
      border-right: 1px solid var(--border);
      width: 131px;
      text-align: center;
    }

    .learn-link {
      display: flex;
      flex-direction: column;
      gap: 0px;
      padding-left: 24px;
      width: 130px;
      text-align: center;
    }

    .hint-label {
      font-size: 12px;
      color: var(--text-dim);
    }

    .hint-value {
      font-size: 14px;
      color: var(--text);
    }

    .learn-link .hint-label {
      text-align: center;
    }

    .learn-link .hint-value {
      color: var(--accent);
    }

    /* Best share */
    .best-share {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .share-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }

    .share-worker {
      font-size: 11px;
      color: var(--text-dim);
    }

    /* Chat */
    .chat-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      border-top: 1px solid var(--border);
      padding-top: 16px;
    }

    .chat-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
      text-align: center;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
      -ms-overflow-style: none;
      scrollbar-width: none;
      mask-image: linear-gradient(to bottom, transparent 0%, black 8%, black 92%, transparent 100%);
      -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 8%, black 92%, transparent 100%);
      padding: 12px 0;
    }

    .chat-messages::-webkit-scrollbar {
      display: none;
    }

    .chat-message {
      font-size: 13px;
      line-height: 1.5;
    }

    .chat-user {
      color: var(--accent);
    }

    .chat-user::after {
      content: ':';
      color: var(--text-dim);
    }

    .chat-text {
      color: var(--text);
    }

    .chat-amount {
      background: linear-gradient(180deg, #ffdc73 0%, #ffaa00 50%, #ff8c00 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }

    /* Progress section */
    .progress-section {
      grid-column: 1 / -1;
      grid-row: 2;
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 16px 20px;
      position: relative;
    }

    .progress-header {
      display: flex;
      justify-content: flex-end;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 12px;
    }

    .progress-label {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .progress-goal {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
    }

    .progress-bar-container {
      position: relative;
      margin-bottom: 8px;
    }

    .progress-bar-bg {
      height: 44px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 3px;
      overflow: hidden;
      position: relative;
    }

    .progress-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(180deg, #79c0ff 0%, #58a6ff 40%, #3d8bdb 100%);
      transition: width 2.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .progress-amount {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-weight: 700;
      color: white;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8), 0 0 10px rgba(0,0,0,0.5);
      letter-spacing: 0.5px;
    }

    .progress-amount .btc-value {
      font-size: 24px;
      color: #fff;
    }

    .progress-amount .btc-label {
      font-size: 15px;
      color: rgba(255,255,255,0.9);
      margin-left: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .progress-ticks {
      display: flex;
      justify-content: space-between;
      padding: 0 2px;
    }

    .tick {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }

    .tick::before {
      content: '';
      width: 1px;
      height: 8px;
      background: var(--border);
      margin-bottom: 4px;
    }

    .tick-label {
      font-size: 14px;
      color: var(--text-dim);
    }

    .tick-label span {
      font-size: 12px;
    }

    /* Custom positions for ticks */
    .progress-ticks-wrapper {
      position: relative;
      height: 20px;
      margin-top: 6px;
      display: flex;
      align-items: flex-start;
    }

    .tick-abs {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .tick-abs::before {
      content: '';
      width: 1px;
      height: 6px;
      background: var(--border);
      margin-bottom: 2px;
    }

    .tick-0 { left: 0; }
    .tick-1 { left: 32%; transform: translateX(-50%); }
    .tick-2 { left: 64%; transform: translateX(-50%); }
    .tick-goal { right: 4px; align-items: flex-end; }
    .tick-goal::before { display: none; }

    .goal-text {
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .goal-label {
      font-size: 14px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .goal-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Video -->
    <div class="video-section">
      
      <img class="video-placeholder" id="video-placeholder" src="" alt="">
      <div class="live-badge">
        <div class="live-dot"></div>
        <span>LIVE</span>
      </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard">
      <div class="logo">
        <img id="logo-img" src="" alt="Telehash" class="logo-img">
      </div>

      <div class="stats-grid">
        <div class="stat">
          <span class="stat-label">Hashrate</span>
          <span class="stat-value"><span id="hashrate-value"></span><span class="unit" id="hashrate-unit"></span></span>
        </div>
        <div class="stat">
          <span class="stat-label">Total Workers</span>
          <span class="stat-value" id="total-workers"></span>
        </div>
        <div class="stat">
          <span class="stat-label">Block Height</span>
          <span class="stat-value" id="block-height"></span>
        </div>
        <div class="stat">
          <span class="stat-label">Bitcoin Price</span>
          <span class="stat-value" id="btc-price"></span>
        </div>
        <div class="stat">
          <span class="stat-label">Blocks Found</span>
          <span class="stat-value" id="blocks-found"></span>
        </div>
        <div class="stat">
          <span class="stat-label">Best Share</span>
          <span class="stat-value" id="best-share"></span>
          <span class="stat-subtext" id="best-share-worker"></span>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Donate Hashrate</div>
        <div class="donate-box">
          <div class="donate-url">tcp://pool.256foundation.org:3333</div>
          <div class="donate-row">
            <div class="donate-hint">
              <span class="hint-label">stratum user:</span>
              <span class="hint-value" style="color: var(--accent);">user.worker</span>
            </div>
            <div class="learn-link">
              <span class="hint-label">learn more:</span>
              <span class="hint-value"><a href="https://dash.256f.org" target="_blank" style="color: inherit; text-decoration: none;">dash.256f.org</a></span>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Donate Bitcoin</div>
        <div class="qr-row">
          <div class="qr-item">
            <div class="qr-code">
              <img class="qr-img" id="on-chain-placeholder" alt="Bitcoin QR">
            </div>
            <span class="qr-label">On-Chain</span>
          </div>
          <div class="qr-item">
            <div class="qr-code">
              <img class="qr-img" id="lightning-placeholder" alt="Lightning QR">
            </div>
            <span class="qr-label">Lightning</span>
          </div>
        </div>
      </div>

      <div class="chat-section">
        <div class="chat-title">Lightning Chat</div>
        <div class="chat-messages" id="chat-messages">
          <!-- Messages populated dynamically -->
        </div>
      </div>
    </div>

    <!-- Progress -->
    <div class="progress-section">
      <div class="progress-bar-container">
        <div class="progress-bar-bg">
          <div class="progress-bar-fill" id="progress-fill"></div>
          <span class="progress-amount"><span class="btc-value" id="btc-raised">0.00000000</span><span class="btc-label">BTC</span></span>
        </div>
      </div>
      <div class="progress-ticks-wrapper">
        <div class="tick-abs tick-0">
          <span class="tick-label">0<span> BTC</span></span>
        </div>
        <div class="tick-abs tick-1">
          <span class="tick-label">1<span> BTC</span></span>
        </div>
        <div class="tick-abs tick-2">
          <span class="tick-label">2<span> BTC</span></span>
        </div>
        <div class="tick-abs tick-goal">
          <span class="goal-text">
            <span class="goal-label">Telehash Goal</span>
            <span class="goal-value">3.125 BTC</span>
          </span>
        </div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
fetch('https://dplusplus.me/images/video-placeholder.txt')
  .then(r => r.text())
  .then(base64 => {
    document.getElementById('video-placeholder').src = `data:image/webp;base64,${base64.trim()}`;
  });

fetch('https://dplusplus.me/images/logo.txt')
  .then(r => r.text())
  .then(base64 => {
    document.getElementById('logo-img').src = `data:image/webp;base64,${base64.trim()}`;
  });

fetch('https://dplusplus.me/images/on-chain.txt')
  .then(r => r.text())
  .then(base64 => {
    document.getElementById('on-chain-placeholder').src = `data:image/webp;base64,${base64.trim()}`;
  });

fetch('https://dplusplus.me/images/lightning.txt')
  .then(r => r.text())
  .then(base64 => {
    document.getElementById('lightning-placeholder').src = `data:image/webp;base64,${base64.trim()}`;
  });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>
  <script>
    const PROM_BASE = "https://bolt12.dplus.plus/256";
    const GOAL_BTC = 3.125;
    let currentBtcRaised = 0;

    // Confetti colors - blue/white theme
    const confettiColors = [
      '#ffffff',
      '#58a6ff',
      '#79c0ff',
      '#38a6ff',
      '#a8d4ff',
      '#c8e1ff',
      '#1a3a6e',
    ];

    function launchConfetti() {
      const duration = 1000;
      const end = Date.now() + duration;

      // Left side burst - angled more toward middle
      (function frameLeft() {
        confetti({
          particleCount: 8,
          angle: 75,
          spread: 100,
          origin: { x: -0.05, y: 0.5 },
          colors: confettiColors,
          startVelocity: 125,
          gravity: 2.5,
          decay: 0.82,
          scalar: 1.6,
          ticks: 70
        });
        confetti({
          particleCount: 8,
          angle: 85,
          spread: 95,
          origin: { x: -0.05, y: 0.65 },
          colors: confettiColors,
          startVelocity: 120,
          gravity: 2.5,
          decay: 0.82,
          scalar: 1.6,
          ticks: 70
        });
        if (Date.now() < end) requestAnimationFrame(frameLeft);
      })();

      // Right side burst - angled more toward middle
      (function frameRight() {
        confetti({
          particleCount: 8,
          angle: 105,
          spread: 100,
          origin: { x: 1.05, y: 0.5 },
          colors: confettiColors,
          startVelocity: 125,
          gravity: 2.5,
          decay: 0.82,
          scalar: 1.6,
          ticks: 70
        });
        confetti({
          particleCount: 8,
          angle: 95,
          spread: 95,
          origin: { x: 1.05, y: 0.65 },
          colors: confettiColors,
          startVelocity: 120,
          gravity: 2.5,
          decay: 0.82,
          scalar: 1.6,
          ticks: 70
        });
        if (Date.now() < end) requestAnimationFrame(frameRight);
      })();
    }

    function animateCountUp(startVal, endVal, duration, callback) {
      const startTime = performance.now();
      const diff = endVal - startVal;
      
      function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const eased = 1 - Math.pow(1 - progress, 3);
        const current = startVal + (diff * eased);
        callback(current);
        if (progress < 1) {
          requestAnimationFrame(update);
        }
      }
      requestAnimationFrame(update);
    }

    let initialLoadComplete = false;
    let onChainLoaded = false;
    let lightningLoaded = false;
    
    function updateProgress(newBtc) {
      // No confetti until both sources have loaded at least once
      const bothLoaded = onChainLoaded && lightningLoaded;
      
      if (newBtc > currentBtcRaised) {
        // Only show confetti after initial load is complete
        if (initialLoadComplete) {
          launchConfetti();
        }
        
        const startVal = currentBtcRaised;
        animateCountUp(startVal, newBtc, 2500, function(val) {
          document.getElementById('btc-raised').textContent = val.toFixed(8);
        });
        
        const percent = (newBtc / GOAL_BTC) * 100;
        document.getElementById('progress-fill').style.width = percent + '%';
        
        currentBtcRaised = newBtc;
      }
      
      // Mark initial load complete once both sources have reported in
      if (bothLoaded && !initialLoadComplete) {
        initialLoadComplete = true;
      }
    }

    function humanHashrate(hPerSec, decimals) {
      decimals = decimals || 2;
      if (!isFinite(hPerSec)) return { value: "—", unit: "" };
      var abs = Math.abs(hPerSec);
      if (abs >= 1e18) return { value: (hPerSec / 1e18).toFixed(decimals), unit: "EH/s" };
      if (abs >= 1e15) return { value: (hPerSec / 1e15).toFixed(decimals), unit: "PH/s" };
      if (abs >= 1e12) return { value: (hPerSec / 1e12).toFixed(decimals), unit: "TH/s" };
      if (abs >= 1e9)  return { value: (hPerSec / 1e9).toFixed(decimals), unit: "GH/s" };
      if (abs >= 1e6)  return { value: (hPerSec / 1e6).toFixed(decimals), unit: "MH/s" };
      if (abs >= 1e3)  return { value: (hPerSec / 1e3).toFixed(decimals), unit: "KH/s" };
      return { value: Math.round(hPerSec).toString(), unit: "H/s" };
    }

    function formatShare(value) {
      if (value >= 1e12) return (value / 1e12).toFixed(2) + 'T';
      if (value >= 1e9) return (value / 1e9).toFixed(2) + 'G';
      if (value >= 1e6) return (value / 1e6).toFixed(2) + 'M';
      if (value >= 1e3) return (value / 1e3).toFixed(2) + 'K';
      return value.toString();
    }

    function promQuery(q) {
      return $.ajax({
        url: PROM_BASE + "/api/v1/query",
        method: "POST",
        data: "query=" + encodeURIComponent(q),
        contentType: "application/x-www-form-urlencoded; charset=UTF-8"
      });
    }

    function updateAllData() {
      // Get address transactions to count coinbase inputs (blocks found)
      const ADDRESS = 'bc1qce93hy5rhg02s6aeu7mfdvxg76x66pqqtrvzs3';
      
      // Use the same API endpoint rotation as balance polling
      const TXS_ENDPOINTS = [
        'https://blockstream.info/api/address/',
        'https://mempool.space/api/address/'
      ];
      
      // Fetch all transactions with pagination
      let allTxs = [];
      let txApiIndex = 0;
      
      function fetchTxs(lastTxid, retryCount) {
        retryCount = retryCount || 0;
        let url = TXS_ENDPOINTS[txApiIndex] + ADDRESS + '/txs';
        if (lastTxid) {
          url += '/chain/' + lastTxid;
        }
        
        $.ajax({
          url: url,
          dataType: 'json',
          timeout: 5000
        })
        .done(function(txs) {
          if (txs && txs.length > 0) {
            allTxs = allTxs.concat(txs);
            
            // If we got 25 results, there might be more
            if (txs.length === 25) {
              const lastTx = txs[txs.length - 1];
              fetchTxs(lastTx.txid, 0);
            } else {
              // Done fetching, now count coinbase transactions
              countCoinbaseTxs(allTxs);
            }
          } else {
            countCoinbaseTxs(allTxs);
          }
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
          console.warn('Txs fetch failed from', TXS_ENDPOINTS[txApiIndex], ':', textStatus);
          
          // Try the other API
          if (retryCount < 1) {
            txApiIndex = (txApiIndex + 1) % TXS_ENDPOINTS.length;
            console.log('Retrying with', TXS_ENDPOINTS[txApiIndex]);
            fetchTxs(lastTxid, retryCount + 1);
          } else {
            console.error('Both APIs failed for txs fetch');
          }
        });
      }
      
      function countCoinbaseTxs(txs) {
        let blocksFound = 0;
        
        txs.forEach(function(tx) {
          // Check if any input is a coinbase
          const hasCoinbaseInput = tx.vin.some(function(vin) {
            return vin.is_coinbase === true;
          });
          
          if (hasCoinbaseInput) {
            blocksFound++;
          }
        });
        
        // Subtract 1 to exclude the initial funding transaction
        document.getElementById('blocks-found').textContent = Math.max(0, blocksFound - 1);
      }
      
      fetchTxs(null, 0);

      // Get 5m hashrate
      promQuery("sum(rate(worker_shares_valid_total[5m]))").done(function(resp) {
        if (resp && resp.status === "success" && resp.data && resp.data.result && resp.data.result.length > 0) {
          var hps = parseFloat(resp.data.result[0].value[1]);
          var hr = humanHashrate(hps, 1);
          document.getElementById('hashrate-value').textContent = hr.value;
          document.getElementById('hashrate-unit').textContent = hr.unit;
        }
      });

      // Get total active workers count
      promQuery("count(sum by (btcaddress, workername) (rate(worker_shares_valid_total[5m])) > 0)").done(function(resp) {
        if (resp && resp.status === "success" && resp.data && resp.data.result && resp.data.result.length > 0) {
          var count = parseInt(resp.data.result[0].value[1]);
          document.getElementById('total-workers').textContent = count.toLocaleString();
        }
      });

      // Get block height - try blockstream first, fallback to mempool
      $.ajax({
        url: "https://blockstream.info/api/blocks/tip/height",
        dataType: 'json',
        timeout: 5000
      })
      .done(function(data) {
        document.getElementById('block-height').textContent = parseInt(data).toLocaleString();
      })
      .fail(function() {
        $.getJSON("https://mempool.space/api/blocks/tip/height", function(data) {
          document.getElementById('block-height').textContent = parseInt(data).toLocaleString();
        });
      });

      // Get Bitcoin price - try mempool.space first, fallback to coingecko
      $.getJSON("https://mempool.space/api/v1/prices")
        .done(function(data) {
          var price = Number(data.USD);
          document.getElementById('btc-price').textContent = '$' + Math.round(price).toLocaleString();
        })
        .fail(function() {
          console.warn('mempool.space price failed, trying coingecko');
          $.getJSON("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd")
            .done(function(data) {
              var price = Number(data.bitcoin.usd);
              document.getElementById('btc-price').textContent = '$' + Math.round(price).toLocaleString();
            })
            .fail(function() {
              console.error('Both price APIs failed');
            });
        });

      // Get best share and worker name
      $.getJSON("https://bolt12.dplus.plus/256/api/v1/query?query=topk(1,%20worker_best_share_ever)", function(data) {
        if (data && data.data && data.data.result && data.data.result.length > 0) {
          var result = data.data.result[0];
          var workerName = result.metric.workername || 'unknown';
          var userName = result.metric.btcaddress || result.metric.username || '';
          
          // If worker is unnamed, use the username/btcaddress instead
          if (workerName.toLowerCase() === 'unnamed' && userName) {
            workerName = userName;
          }
          
          var shareValue = parseFloat(result.value[1]);
          document.getElementById('best-share').textContent = formatShare(shareValue);
          document.getElementById('best-share-worker').textContent = workerName;
        }
      });
    }

    $(document).ready(function() {
      updateAllData();
      setInterval(updateAllData, 10000);
      
      // Fast polling for address balance (every 2 seconds to be safe with rate limits)
      pollAddressBalance();
      setInterval(pollAddressBalance, 2000);
      
      // Poll chat messages - hardcoded start timestamp
      const chatStartTime = 1768680788;
      pollChatMessages(chatStartTime);
      setInterval(function() {
        pollChatMessages(Math.floor(new Date().getTime() / 1000) - 60); // Last 60 seconds for updates
      }, 2000);
    });
    
    // Chat message tracking
    const chatMessages = {};
    
    function sanitizeMessage(raw) {
      return raw.replace(/<script[^>]*?>.*?<\/script>/gi, '')
                .replace(/<\/?script[^>]*?>/gi, '')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
    }
    
    function displayChatMessage(rawMessage, time, amount) {
      let username = 'anon';
      let message = rawMessage;
      
      if (rawMessage && rawMessage.includes(':')) {
        username = sanitizeMessage(rawMessage.split(':')[0].trim());
        message = sanitizeMessage(rawMessage.split(':').slice(1).join(':').trim());
      } else if (rawMessage) {
        message = sanitizeMessage(rawMessage);
      }
      
      const amountDisplay = amount > 1 ? `<span class="chat-amount">⚡${Number(amount).toLocaleString()}</span>` : '';
      
      const messageHtml = `<div class="chat-message">
        <span class="chat-user">${username}</span>
        <span class="chat-text"> ${message}</span>${amountDisplay}
      </div>`;
      
      $('#chat-messages').append(messageHtml);
      $('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);
    }
    
    function pollChatMessages(dateStart) {
      $.post('https://dpluspl.us/api/telehash', { address: 'donate@www.256f.org', dateStart: dateStart })
        .done(function(result) {
          if (result && result.length > 0) {
            for (let i = 0; i < result.length; i++) {
              const msg = result[i];
              if (!(msg.index in chatMessages)) {
                chatMessages[msg.index] = { processed: false };
                // Skip backend test messages
                if (msg.memo && msg.memo.trim() !== '| I love you!') {
                  displayChatMessage(msg.memo, msg.date, msg.amount);
                }
                chatMessages[msg.index].processed = true;
              }
            }
          }
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
          console.warn('Chat API error:', textStatus, errorThrown);
        });
    }
    
    // Separate fast poll for address balance to detect donations quickly
    const API_ENDPOINTS = [
      'https://blockstream.info/api/address/',
      'https://mempool.space/api/address/'
    ];
    let currentApiIndex = 0;
    let consecutiveFailures = 0;
    
    // Track on-chain and lightning balances separately
    let onChainSats = 0;
    let lightningSats = 0;
    
    function switchApi() {
      currentApiIndex = (currentApiIndex + 1) % API_ENDPOINTS.length;
      console.log('Switching to API:', API_ENDPOINTS[currentApiIndex]);
      consecutiveFailures = 0;
    }
    
    function updateTotalBalance() {
      const totalSats = onChainSats + lightningSats;
      const totalBtc = totalSats / 100000000;
      updateProgress(totalBtc);
    }
    
    function pollAddressBalance() {
      const ADDRESS = 'bc1qce93hy5rhg02s6aeu7mfdvxg76x66pqqtrvzs3';
      const apiUrl = API_ENDPOINTS[currentApiIndex] + ADDRESS;
      
      // Poll on-chain balance
      $.ajax({
        url: apiUrl,
        dataType: 'json',
        timeout: 5000
      })
        .done(function(data) {
          const confirmedBalance = data.chain_stats.funded_txo_sum - data.chain_stats.spent_txo_sum;
          const unconfirmedBalance = data.mempool_stats.funded_txo_sum - data.mempool_stats.spent_txo_sum;
          onChainSats = confirmedBalance + unconfirmedBalance;
          
          // If we got all zeros, might be rate limited - count as failure
          if (onChainSats === 0 && data.chain_stats.tx_count > 0) {
            console.warn('Got zero balance but tx_count > 0, possible rate limit');
            consecutiveFailures++;
            if (consecutiveFailures >= 3) {
              switchApi();
            }
            return;
          }
          
          // Success - reset failure count
          consecutiveFailures = 0;
          onChainLoaded = true;
          
          updateTotalBalance();
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
          consecutiveFailures++;
          
          if (jqXHR.status === 429) {
            console.warn('RATE LIMITED (429) by', API_ENDPOINTS[currentApiIndex]);
            switchApi();
          } else if (textStatus === 'timeout') {
            console.warn('TIMEOUT from', API_ENDPOINTS[currentApiIndex]);
            if (consecutiveFailures >= 2) {
              switchApi();
            }
          } else {
            console.error('API error from', API_ENDPOINTS[currentApiIndex], ':', jqXHR.status, textStatus, errorThrown);
            if (consecutiveFailures >= 3) {
              switchApi();
            }
          }
        });
      
      // Poll Lightning balance
      const lightningAddress = 'donate@www.256f.org';
      $.post('https://dpluspl.us/api/checkInvStatus', { address: lightningAddress })
        .done(function(result) {
          let amount = 0;
          if (result && result.length > 0) {
            for (var i = 0; i < result.length; i++) {
              amount += Number(result[i].value);
            }
          }
          lightningSats = amount;
          lightningLoaded = true;
          updateTotalBalance();
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
          console.warn('Lightning API error:', textStatus, errorThrown);
        });
    }
  </script>
</body>
</html>

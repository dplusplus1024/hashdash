
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1920, height=1080">
  <title>TELEHASH // LIVE</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      width: 1920px;
      height: 1080px;
      background: transparent;
      overflow: hidden;
      font-family: 'JetBrains Mono', monospace;
    }

    .iframe-container {
      position: relative;
      width: 1920px;
      height: 1080px;
    }

    /* Background frame - blue with video cutout (sits behind iframes) */
    .bg-frame {
      position: absolute;
      top: 0;
      left: 0;
      width: 1920px;
      height: 1080px;
      pointer-events: none;
      z-index: 0;
    }

    .bg-top {
      position: absolute;
      top: 0;
      left: 0;
      width: 1920px;
      height: 16px;
      background: #060e1f;
    }

    .bg-right {
      position: absolute;
      top: 0;
      right: 0;
      width: 412px;
      height: 1080px;
      background: #060e1f;
    }

    .bg-bottom {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 1508px;
      height: 138px;
      background: #060e1f;
    }

    .bg-left {
      position: absolute;
      top: 0;
      left: 0;
      width: 16px;
      height: 1080px;
      background: #060e1f;
    }

    .bg-ticker {
      position: absolute;
      bottom: 138px;
      left: 16px;
      width: 1492px;
      height: 50px;
      background: #060e1f;
    }

    .dashboard-frame {
      position: absolute;
      top: 0;
      left: 0;
      width: 1920px;
      height: 1080px;
      border: none;
      opacity: 1;
      filter: blur(0px);
      transition: opacity 0.4s ease-out, filter 0.4s ease-out;
      z-index: 1;
    }

    .dashboard-frame.fade-out {
      opacity: 0;
      filter: blur(8px);
    }

    .dashboard-frame.hidden {
      visibility: hidden;
      pointer-events: none;
    }

    /* Overlay pieces that fade in during transition - avoids video cutout */
    .transition-overlay {
      position: absolute;
      background: #060e1f;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease-out;
      z-index: 20;
    }

    .transition-overlay.visible {
      opacity: 1;
    }

    .overlay-top {
      top: 0;
      left: 0;
      width: 1920px;
      height: 16px;
    }

    .overlay-right {
      top: 0;
      right: 0;
      width: 412px;
      height: 1080px;
    }

    .overlay-bottom {
      bottom: 0;
      left: 0;
      width: 1508px;
      height: 138px;
    }

    .overlay-left {
      top: 0;
      left: 0;
      width: 16px;
      height: 1080px;
    }

    .overlay-ticker {
      bottom: 136px;
      left: 15px;
      width: 1494px;
      height: 52px;
    }

    /* Version indicator (hidden by default, useful for debugging) */
    .version-indicator {
      position: absolute;
      bottom: 10px;
      left: 10px;
      font-size: 10px;
      color: rgba(255,255,255,0.2);
      z-index: 100;
      display: none; /* Set to block for debugging */
    }
  </style>
</head>
<body>
  <div class="iframe-container">
    <div class="bg-frame">
      <div class="bg-top"></div>
      <div class="bg-right"></div>
      <div class="bg-bottom"></div>
      <div class="bg-left"></div>
      <div class="bg-ticker"></div>
    </div>
    <div class="transition-overlay overlay-top" id="overlay-top"></div>
    <div class="transition-overlay overlay-right" id="overlay-right"></div>
    <div class="transition-overlay overlay-bottom" id="overlay-bottom"></div>
    <div class="transition-overlay overlay-left" id="overlay-left"></div>
    <div class="transition-overlay overlay-ticker" id="overlay-ticker"></div>
    <iframe id="frame-a" class="dashboard-frame" src=""></iframe>
    <iframe id="frame-b" class="dashboard-frame hidden" src=""></iframe>
  </div>
  <div class="version-indicator" id="version-indicator">v<span id="version-display">0</span></div>

  <script>
    // Configuration
    const CONFIG = {
      // URL to your dashboard HTML file
      dashboardUrl: 'https://dash.256f.org/source.html',
      
      // URL to your version API endpoint
      // Should return JSON: { "version": 123 } or just a number
      versionApiUrl: 'https://dpluspl.us/api/teledashVersion',
      
      // How often to check for updates (in milliseconds)
      pollInterval: 5000,
      
      // Transition timing (in milliseconds)
      fadeOutDuration: 400,
      fadeInDuration: 400,
      overlayHoldDuration: 200
    };

    // State
    let currentVersion = 0;
    let activeFrame = 'a';
    let isTransitioning = false;

    // Elements
    const frameA = document.getElementById('frame-a');
    const frameB = document.getElementById('frame-b');
    const overlays = [
      document.getElementById('overlay-top'),
      document.getElementById('overlay-right'),
      document.getElementById('overlay-bottom'),
      document.getElementById('overlay-left'),
      document.getElementById('overlay-ticker')
    ];
    const versionDisplay = document.getElementById('version-display');

    // Helper to toggle overlay visibility
    function setOverlayVisible(visible) {
      overlays.forEach(o => {
        if (visible) {
          o.classList.add('visible');
        } else {
          o.classList.remove('visible');
        }
      });
    }

    // Get the currently active and inactive frames
    function getFrames() {
      if (activeFrame === 'a') {
        return { active: frameA, inactive: frameB };
      } else {
        return { active: frameB, inactive: frameA };
      }
    }

    // Load initial dashboard
    function init() {
      console.log('[Container] Initializing dashboard...');
      frameA.src = CONFIG.dashboardUrl + '?v=' + Date.now();
      
      // Start version polling after initial load
      frameA.onload = function() {
        console.log('[Container] Initial dashboard loaded');
        startVersionPolling();
      };
    }

    // Check for version updates
    async function checkVersion() {
      if (isTransitioning) {
        console.log('[Container] Skipping version check - transition in progress');
        return;
      }

      try {
        const response = await fetch(CONFIG.versionApiUrl + '?t=' + Date.now());
        const data = await response.json();
        
        // Handle both { version: 123 } and raw number responses
        const newVersion = typeof data === 'number' ? data : data.version;
        
        console.log('[Container] Version check:', currentVersion, '->', newVersion);
        
        if (newVersion > currentVersion) {
          console.log('[Container] New version detected! Refreshing...');
          currentVersion = newVersion;
          versionDisplay.textContent = newVersion;
          await performTransition();
        }
      } catch (error) {
        console.warn('[Container] Version check failed:', error.message);
      }
    }

    // Perform the blur-fade transition
    async function performTransition() {
      if (isTransitioning) return;
      isTransitioning = true;
      console.log('[Container] Starting transition...');

      const { active, inactive } = getFrames();

      // Step 1: Start loading new content
      console.log('[Container] Loading new content...');
      
      await new Promise((resolve) => {
        inactive.onload = resolve;
        inactive.src = CONFIG.dashboardUrl + '?v=' + Date.now();
      });
      console.log('[Container] New content loaded, waiting for data to populate...');
      
      // Wait for API/Nostr data to load
      await sleep(10000);
      console.log('[Container] Ready to transition');

      // Step 2: NOW fade out active frame + show overlay
      console.log('[Container] Fading out...');
      active.classList.add('fade-out');
      setOverlayVisible(true);

      // Wait for fade out
      await sleep(CONFIG.fadeOutDuration);
      console.log('[Container] Fade out complete');

      // Step 3: Swap frames while overlay is solid
      active.classList.add('hidden');
      active.classList.remove('fade-out');
      
      inactive.classList.remove('hidden');
      inactive.classList.add('fade-out'); // Start faded
      
      // Brief hold on solid background
      await sleep(CONFIG.overlayHoldDuration);

      // Step 4: Fade in new frame + hide overlay
      console.log('[Container] Fading in...');
      inactive.classList.remove('fade-out');
      setOverlayVisible(false);

      // Wait for fade in
      await sleep(CONFIG.fadeInDuration);
      console.log('[Container] Transition complete');

      // Step 6: Cleanup and swap active reference
      activeFrame = activeFrame === 'a' ? 'b' : 'a';
      isTransitioning = false;

      console.log('[Container] Transition complete, active frame:', activeFrame);
    }

    // Start polling for version updates
    function startVersionPolling() {
      // Do an immediate check
      checkVersion();
      
      // Then poll at interval
      setInterval(checkVersion, CONFIG.pollInterval);
    }

    // Utility: sleep function
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Manual refresh function (can be called from console for testing)
    window.forceRefresh = async function() {
      console.log('[Container] Manual refresh triggered');
      currentVersion++;
      versionDisplay.textContent = currentVersion;
      await performTransition();
    };

    // Initialize on load
    init();
  </script>
</body>
</html>

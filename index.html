


<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="referrer" content="no-referrer">
  <title>256 Foundation • Hashdash</title>

  <script src="https://unpkg.com/nostr-tools@2.19.4/lib/nostr.bundle.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <style>
    :root{
      --bg0:#070b14;
      --bg1:#0a1024;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --accent:#38a6ff;
      --good:#39d98a;
      --bad:#ff5b7a;
      --shadow: 0 22px 70px rgba(0,0,0,.55);
      --r:26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    html,body{
      height:100%;
      margin:0;
      background:
        radial-gradient(1200px 700px at 14% 18%, rgba(56,166,255,.32), transparent 55%),
        radial-gradient(900px 700px at 82% 22%, rgba(140,103,255,.26), transparent 55%),
        radial-gradient(900px 900px at 55% 92%, rgba(37,196,255,.14), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      font-family: var(--sans);
      overflow-x:hidden;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    a{ color: rgba(170,220,255,.95); text-decoration: none; }
    a:hover{ text-decoration: underline; }

    .wrap{
      max-width: 1240px;
      margin: 0 auto;
      padding: 28px 18px 34px;
    }

    /* HEADER */
    .top{
      display:flex;
      align-items:center;
      gap:16px;
      margin-bottom:18px;
    }

    .logo{
      width:75px;height:75px;border-radius:18px;
      background: #ffffff;
      box-shadow: 0 18px 55px rgba(56,166,255,.25);
      border: 1px solid rgba(255,255,255,.18);
      flex: 0 0 auto;
      object-fit: contain;
      padding: 6px;
      box-sizing: border-box;
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width: 0;
    }

    h1{
      font-size: 34px;
      line-height: 1.05;
      margin:0;
      letter-spacing: .2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .sub{
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-family: var(--mono);
      font-size: 14px;
      letter-spacing:.2px;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(12px);
      white-space: nowrap;
    }

    #lastUpdate{
      width: 36ch;
    }
    #pill-status {
      width: calc(9ch - 4px);
    }
    #pill-powered {
      width: calc(22ch - 4px);
    }

    .dot{
      width:8px;height:8px;border-radius:999px;
      background: var(--good);
      box-shadow: 0 0 0 4px rgba(57,217,138,.15);
    }
    .dot.pulse {
      animation: pulse 2s infinite;
    }
    .dot.bad{
      background: var(--bad);
      box-shadow: 0 0 0 4px rgba(255,91,122,.15);
      animation: none;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(57, 217, 138, 0.4); }
      70% { box-shadow: 0 0 0 6px rgba(57, 217, 138, 0); }
      100% { box-shadow: 0 0 0 0 rgba(57, 217, 138, 0); }
    }

    /* GRID SYSTEM */
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:16px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.075), rgba(255,255,255,.045));
      border: 1px solid rgba(255,255,255,.13);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
      backdrop-filter: blur(16px);
    }

    .card::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(600px 180px at 30% 0%, rgba(56,166,255,.20), transparent 60%),
        radial-gradient(520px 260px at 92% 12%, rgba(140,103,255,.16), transparent 60%);
      pointer-events:none;
      opacity:.9;
    }

    .cardInner{
      position:relative;
      padding:22px 22px 18px;
    }

    .sectionTitle{
      font-family: var(--mono);
      letter-spacing: .32em;
      text-transform: uppercase;
      font-size: 14px;
      color: rgba(255,255,255,.55);
      margin: 0 0 12px;
    }

    .headRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }

    .meta{
      color: rgba(255,255,255,.50);
      font-family: var(--mono);
      font-size: 15px;
      letter-spacing:.02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Overview */
    .overview{ grid-column: 1 / -1; }

    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:16px;
    }

    .kpiTile{
      grid-column: span 3;
      min-height: 118px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      position: relative;
      transition: transform 0.2s ease, border-color 0.2s ease, background 0.2s ease;
    }
    .kpiTile:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,.25);
      background: rgba(255,255,255,.08);
    }

    .kpiTileInner{ padding:16px 16px 14px; position:relative; z-index:2; }

    .kpiBgIcon{
      position:absolute;
      right: -10px;
      bottom: -10px;
      font-size: 80px;
      color: rgba(255,255,255,.03);
      transform: rotate(-15deg);
      pointer-events: none;
      z-index: 1;
    }

    .kpiTile .label{
      color: rgba(255,255,255,.62);
      font-family: var(--mono);
      font-size: 14px; 
      letter-spacing:.04em;
      margin:0 0 8px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .kpiTile .label i {
      color: var(--accent);
      font-size: 14px;
      opacity: 0.8;
    }

    .kpiTile .value{
      font-weight: 700;
      font-size: 52px;
      line-height: 1;
      margin:0;
      letter-spacing: .5px;
    }

    .kpiTile.small .value{ font-size: 48px; }

    .kpiTile .value .unit{
      font-size: .55em;
      color: rgba(255,255,255,.78);
      margin-left: 8px;
      letter-spacing:.02em;
    }

    /* Charts Row */
    .chartsRow{
      grid-column: 1 / -1;
      display:grid;
      grid-template-columns: 8fr 4fr;
      gap:16px;
    }

    .trendCard{ min-height: 420px; }

    .canvasWrap, .pieWrap{
      position:relative;
      height: 320px;
      margin-top: 8px;
      border-radius: 18px;
      overflow:hidden;
    }

    .canvasWrap{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
    }

    .pieWrap{
      border: none;
      background: transparent;
    }

    .piePad{
      position:absolute;
      inset: 18px;
    }

    canvas{
      display:block;
      width:100% !important;
      height:100% !important;
    }

    /* Users/workers list BELOW */
    .usersCard{
      grid-column: 1 / -1;
      width: 100%;
      max-width: none;
      justify-self: stretch;
    }

    .usersContentConstrainer {
      width: 80%;
      margin: 0 auto;
    }

    /* NEW HEADER LAYOUT FOR USERS CARD - FORCE CENTER TITLE + RIGHT TOGGLE */
    .usersHeadRow {
      position: relative; /* Allows absolute positioning of children */
      display: flex;
      justify-content: center; /* Forces Title to center */
      align-items: center;
      margin-bottom: 14px;
      min-height: 32px;
    }

    .usersHeadRow .sectionTitle {
      margin: 0; /* Remove default margin to center perfectly */
      white-space: nowrap;
    }

    .toggleContainer {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 16px; /* Added gap for separation */
    }

    .narrowBlock{
      max-width: 980px;
      margin: 0 auto;
    }

    /* =========================
        FILTER BAR
    ========================= */

    .filterBar{
      display:flex;
      align-items:center;
      gap:14px;
      margin: 6px 0 14px;
    }

    .filterField{
      position: relative;
      flex: 1 1 auto;
      min-width: 0;
    }

    .filterField i{
      position:absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255,255,255,.55);
      opacity: .95;
      font-size: 16px;
      pointer-events:none;
    }

    #userFilter{
      width: 100%;
      /* height: 56px; */
      height:45px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      font-family: var(--mono);
      font-size: 16px;
      padding: 0 18px 0 50px;
      outline: none;
      backdrop-filter: blur(12px);
      box-shadow: 0 14px 44px rgba(0,0,0,.18);
      box-sizing: border-box;
    }

    #userFilter::placeholder{
      color: rgba(255,255,255,.42);
    }

    #userFilter:focus{
      border-color: rgba(56,166,255,.30);
      background: rgba(255,255,255,.075);
    }

    .filterBtn{
      height: 45px;
      padding: 0 22px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(140,103,255,.18);
      color: rgba(255,255,255,.86);
      font-family: var(--mono);
      font-size: 13px;
      letter-spacing: .15em;
      text-transform: uppercase;
      cursor: pointer;
      backdrop-filter: blur(12px);
      box-shadow: 0 14px 44px rgba(0,0,0,.18);
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease, opacity 120ms ease;
      flex: 0 0 auto;
    }

    .filterBtn:hover{
      background: rgba(140,103,255,.24);
      border-color: rgba(255,255,255,.20);
      transform: translateY(-1px);
    }

    .filterBtn:active{
      transform: translateY(0px) scale(.995);
    }

    .filterBtn:disabled{
      opacity: .45;
      cursor: default;
      transform: none;
    }

    .chicToggle{
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      font-family: var(--mono);
      font-size:11px;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: rgba(255,255,255,.6);
      flex: 0 0 auto;
      transition: color 0.2s;
    }
    .chicToggle:hover { color: rgba(255,255,255,.9); }

    .chicToggle input { display:none; }

    .chicToggle .track {
      width: 34px; height: 18px; /* Slightly smaller for header */
      background: rgba(255,255,255,.08);
      border-radius: 99px;
      position: relative;
      transition: background 0.2s ease, border-color 0.2s ease;
      border: 1px solid rgba(255,255,255,.15);
    }

    .chicToggle .thumb {
      width: 12px; height: 12px;
      background: rgba(255,255,255,.4);
      border-radius: 50%;
      position: absolute; 
      top: 3px; left: 3px;
      transition: transform 0.2s cubic-bezier(0.4, 0.0, 0.2, 1), background 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,.2);
    }

    .chicToggle input:checked + .track {
      background: rgba(56,166,255,.15);
      border-color: var(--accent);
    }

    .chicToggle input:checked + .track .thumb {
      transform: translateX(14px);
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }

    /* SCROLL LIST */
    .list{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top: -10px;
      max-height: 800px;
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 0;
      scroll-behavior: smooth;
      mask-image: linear-gradient(to bottom, 
        transparent 0%, 
        black 24px, 
        black calc(100% - 24px), 
        transparent 100%
      );
      -webkit-mask-image: linear-gradient(to bottom, 
        transparent 0%, 
        black 24px, 
        black calc(100% - 24px), 
        transparent 100%
      );
      padding-top: 24px;
      padding-bottom: 24px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .list::-webkit-scrollbar {
      display: none;
      width: 0;
      height: 0;
    }

    .row{
      padding:12px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }

    .minerTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      column-gap:12px;
      row-gap:2px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .addr{
      font-family: var(--mono);
      font-size: 13px;
      color: rgba(255,255,255,.90);
      white-space: normal;
      overflow-wrap: anywhere;
      cursor: default;
      border-radius: 6px;
      /* tighter padding on top and bottom */
      padding: 0px 6px;
      /* padding: 4px 6px; */
      margin-left: -6px;
      transition: background 120ms;
    }
    .addr a{
      cursor: pointer;
    }
    .addr:hover{
      background: rgba(255,255,255,.06);
    }

    .totalHash{
      font-family: var(--mono);
      font-size: 13px;
      color: rgba(255,255,255,.92);
      white-space:nowrap;
      flex: 0 0 auto;
      margin-left: auto;
    }

    .totalHash.hideSingleWorker{
      display: none;
    }

    /* Workers box */
    .workersWrap{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .workers{
      display:flex;
      flex-direction:column;
      /* TIGHTER SPACING */
      gap:2px;
      padding: 8px 8px;
      border-radius: 16px;
      background: rgba(0,0,0,.14);
      border: 1px solid rgba(255,255,255,.08);
    }

    .workerLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-family: var(--mono);
      font-size: 13px;
      color: rgba(255,255,255,.78);
      cursor: default;
      /* TIGHTER LINE HEIGHT */
      padding: 3px 6px;
      border-radius: 6px;
      transition: background 0.1s ease;
    }
    .workerLine a{
      cursor: pointer;
    }
    .workerLine:hover{
        background: rgba(255,255,255,.06);
        color: rgba(255,255,255,.95);
    }

    .workerLeft{
      display:flex;
      align-items:center;
      gap:8px;
      min-width: 0;
      flex: 1 1 auto;
    }

    .badgeDot{
      width:8px;height:8px;border-radius:999px;
      background: var(--good);
      box-shadow: 0 0 0 4px rgba(57,217,138,.12);
      flex: 0 0 auto;
    }
    .badgeDot.bad{
      background: var(--bad);
      box-shadow: 0 0 0 4px rgba(255,91,122,.12);
    }

    .workerName{
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 620px;
      color: rgba(255,255,255,.82);
    }

    .workerName a{
      display: block;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .workerRight{
      display:flex;
      align-items:center;
      gap:10px;
      flex: 0 0 auto;
      white-space: nowrap;
      color: rgba(255,255,255,.62);
    }

    .lastBadge{
      display:inline-flex;
      align-items:center;
      justify-content: left; 
      gap:8px;
      /* padding: 4px 10px; */
      padding: 4px 10px 4px 9px;
      /* width: 130px;  */
      width: 19ch;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.70);
      font-family: var(--mono);
      font-size: 12px;
      white-space: nowrap;
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
    }

    .error{
      color: rgba(255,91,122,.95);
      font-family: var(--mono);
      font-size: 13px;
      margin-top: 12px;
    }

    /* TOOLTIP */
    #hoverTip{
      position: fixed;
      z-index: 9999;
      pointer-events: none;
      opacity: 0;
      /* Remove transform for manual positioning logic */
      transition: opacity 80ms linear;
      background: rgba(0,0,0,.85);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 12px;
      padding: 10px 14px;
      box-shadow: 0 18px 55px rgba(0,0,0,.6);
      color: rgba(255,255,255,.92);
      font-family: var(--mono);
      font-size: 12px;
      white-space: nowrap;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      transform: translateZ(0);
    }
    #hoverTip.show{
      opacity: 1;
    }
    #hoverTip .muted{
      color: rgba(255,255,255,.70);
    }

    /* =========================
        DONATIONS
    ========================= */
    .donationsRow{
      grid-column: 1 / -1;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
    }

    .centerTitle{
      width:100%;
      text-align:center;
    }

    .copyLabel{
      margin: 12px 0 8px;
      color: rgba(255,255,255,.72);
      font-size: 16px;
    }

    .copyField{
      display:flex; 
      justify-content:space-between; 
      align-items:center;
      gap: 12px;
      padding: 14px 16px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.90);
      font-family: var(--mono);
      font-size: 16px;
      overflow-wrap: anywhere;
      cursor: pointer;
      user-select: none;
      transition: transform 90ms ease, background 90ms ease, border-color 90ms ease;
    }

    .copyField i {
        opacity: 0.5;
        font-size: 14px;
    }

    .copyField:hover{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.16);
    }

    .copyField:hover i { opacity: 1; }

    .copyField:active{
      transform: scale(.995);
    }

    /* =========================
        DIFFICULTY LEADERBOARD
    ========================= */

    .leaderboardCard{
      grid-column: 1 / -1;
      width: 100%;
      max-width: none;
      justify-self: stretch;
      padding-bottom: 10px;
    }

    .leaderboardContent{
      width: 70%;
      max-width: 820px;
      margin: 0 auto;
    }

    .leaderboardHeader{
      display: grid;
      grid-template-columns: 70px 120px 1fr;
      gap: 24px;
      padding: 12px 24px;
      color: rgba(255,255,255,.5);
      font-family: var(--mono);
      font-size: 13px;
      letter-spacing: .06em;
      text-transform: uppercase;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }

    .leaderboardRow{
      display: grid;
      grid-template-columns: 70px 120px 1fr;
      gap: 24px;
      padding: 14px 24px;
      align-items: center;
      border-bottom: 1px solid rgba(255,255,255,.05);
      transition: background 150ms ease;
    }

    .lbWhen{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(255,255,255,.35);
      font-style: italic;
    }

    .leaderboardRow:hover{
      background: rgba(255,255,255,.03);
    }

    .leaderboardRow:last-child{
      border-bottom: none;
    }

    .lbRank{
      font-family: var(--mono);
      font-size: 16px;
      font-weight: 600;
      color: rgba(255,255,255,.5);
      padding-left: 10px;
      letter-spacing: 0.02em;
    }

    .lbRank.medal{
      font-size: 22px;
      padding-left: 0;
    }

    .lbDiff{
      font-family: var(--mono);
      font-size: 14px;
      font-weight: 400;
      letter-spacing: 0.01em;
    }

    .lbDiffNum{
      color: rgba(255,255,255,.7);
    }

    .lbDiffUnit{
      color: rgba(255,255,255,.35);
      font-size: 0.9em;
    }

    .lbUser{
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .lbUser a{
      color: var(--accent);
      text-decoration: none;
    }

    .lbUser a:hover{
      text-decoration: underline;
    }

    .lbUserName{
      font-family: var(--mono);
      font-size: 14px;
      color: rgba(255,255,255,.85);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .lbWorkerName{
      color: rgba(255,255,255,.5);
    }

    .row.highlight-flash{
      animation: flashHighlight 3s ease-out;
    }

    @keyframes flashHighlight{
      0%{ background: rgba(56,166,255,0.35); }
      50%{ background: rgba(56,166,255,0.35); }
      100%{ background: rgba(255,255,255,.06); }
    }

    .leaderboardCard .sectionTitle{
      text-align: center;
    }

    @media (max-width: 550px){
      .lbWorkerName{
        display: none;
      }
    }

    @media (max-width: 980px){
      .leaderboardContent{ width: 100%; }
    }

    @media (max-width: 740px){
      .leaderboardHeader,
      .leaderboardRow{
        grid-template-columns: 50px 100px 1fr;
        gap: 12px;
        padding: 12px 16px;
      }
    }

    @media (max-width: 700px){
      .lbDiff{ font-size: 13px; }
      .lbUserName{ font-size: 13px; }
      .lbRank{ font-size: 13px; }
    }

    @media (max-width: 500px){
      .leaderboardHeader,
      .leaderboardRow{
        grid-template-columns: 45px 80px 1fr;
        gap: 10px;
        padding: 10px 12px;
      }
    }

    @media (max-width: 400px){
      .lbDiff{ font-size: 11px; }
      .lbUserName{ font-size: 11px; }
      .lbRank{ font-size: 11px; }
    }

    /* =========================
        WORKERS TOGGLE
    ========================= */

    .workersExtra{
      overflow:hidden;
       max-height: 999999px;
      opacity: 1;
      transform: translateY(0px);
      transition:
        max-height 260ms cubic-bezier(.2,.9,.2,1),
        opacity 180ms ease,
        transform 260ms cubic-bezier(.2,.9,.2,1);
      will-change: max-height, opacity, transform;
      display: flex;
      flex-direction: column;
      /* Matches .workers gap */
      gap: 2px;
    }

    .workers.collapsed .workersExtra{
      max-height: 0px;
      opacity: 0;
      transform: translateY(-6px);
      transition:
        max-height 240ms cubic-bezier(.4,0,.2,1),
        opacity 160ms ease,
        transform 240ms cubic-bezier(.4,0,.2,1);
    }

    .workersToggleRow{
      display:flex;
      justify-content:center;
      padding-top: 6px;
      padding-bottom: 2px;
    }

    .toggleMore{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.82);
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: .22em;
      text-transform: uppercase;
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 44px rgba(0,0,0,.22);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toggleMore:hover{
      background: rgba(255,255,255,.085);
      border-color: rgba(255,255,255,.20);
      transform: translateY(-1px);
    }

    .toggleMore:active{
      transform: translateY(0px) scale(.995);
    }

    .toggleMore i {
        margin-top: -2px; 
    }

    .toggleMore .count{
      letter-spacing: .10em;
      color: rgba(255,255,255,.68);
      margin-left: 0px;
    }

    /* Responsive */
    @media (max-width: 1100px) and (min-width: 981px){
      .kpiTile .value .unit{ font-size: .35em; }
      .copyField{ font-size: 14px; }
    }

    @media (max-width: 980px){
      .kpiTile{ grid-column: span 6; }
      .chartsRow{ grid-template-columns: 1fr; }
      .workerName{ max-width: 380px; }
      .piePad{ inset: 16px; }
      .narrowBlock{ max-width: 100%; }
      .donationsRow{ grid-template-columns: 1fr; }
      .usersContentConstrainer { width: 100%; }
    }

    /* almost phone */
    @media (max-width: 740px){
      .usersHeadRow {
        justify-content: left;
      }
      .centerTitle{
        width:100%;
        text-align:left;
      }
    }

    @media (max-width: 750px) and (min-width: 621px) {
      .pill {
        font-size:11px;
      }
       #pill-status {
        /* this is kinda psycho but idk i may change this.... */
        /* margin-right:6.5px; */
      }
    }

    /* mobile layout */
    @media (max-width: 620px){
      .list { margin-top: -20px; }

      /* .chicToggle { display:none; }  */

      #filterReset { display: none; }

      /* Header Layout */
      .top {
        align-items: flex-start; /* Aligns logo to top of text */
        gap: 12px;
        margin-bottom: 22px;
      }

      /* Resized Logo */
      .logo {
        display: block; /* Unhide */
        width: 48px;
        height: 48px;
        border-radius: 12px; /* Tighter radius for mobile */
        padding: 4px;
        box-shadow: 0 8px 20px rgba(56,166,255,.20); /* Softer shadow */
      }

      /* Title area */
      .title {
        min-width: 0;
        flex: 1 1 auto;
      }

      h1 { 
        font-size: 22px; /* Balanced size */
        white-space: normal;
        overflow: visible;
        line-height: 1.15;
      }

      /* FIX 1: Pills WRAP naturally instead of scrolling off-screen */
      .sub {
        /* margin-top: 8px; */
        flex-wrap: wrap; /* Wrap allows multiple lines */
        gap: 8px; /* Tighter gap for mobile */
      }

      /* Make pills slightly more compact */
      .pill {
        font-size: 11px;
        padding: 4px 10px;
        flex: 0 0 auto; /* Don't shrink */
      }

      #pill-status {
        width:9ch;
      }

      #pill-powered {
        width:22ch;
      }

      /* Rest of mobile styles */
      .kpiTile{ grid-column: span 12; }
      .kpiTile .value{ font-size: 54px; }
      .canvasWrap  { height: 280px }
      .pieWrap { height: 300px }


      
      .piePad{ inset: 14px; }
      .trendCard{ min-height: 390px; }
      .addr{ flex-direction:column; align-items:flex-start; gap:6px; }
      .lastBadge{ display:none; }
      .filterBar{ 
        flex-direction:column; 
        align-items:stretch; 
      }
      .filterField {
        width: 100%;
        margin-bottom: 8px;
      }
      #userFilter{ 
        /* height: 54px;  */
        height:45px;
        width: 100%;
      }
      .filterBtn{ 
        width: 100%; 
        height: 54px; 
        padding: 0 18px; 
      }
      .list{ max-height: 800px; padding-right: 0px; }

      /* Toggle on Mobile - Ensure it stays in Header Grid */
      .usersHeadRow {
        margin-bottom: 12px;
      }

      /* iOS-safe tooltip sizing + wrapping */
      #hoverTip{
        max-width: calc(100vw - 24px);
        white-space: normal;
        overflow-wrap: anywhere;
        word-break: break-word;
        line-height: 1.25;
      }
      #hoverTip .muted{
        display:block;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <img src="https://i.imgur.com/Fiot6qk.png" class="logo" alt="256 Foundation">
      <div class="title">
        <h1>256 Foundation &nbsp;<span style="font-size:80%"><i class="fa-solid fa-screwdriver-wrench"></i></span>&nbsp; Hashdash</h1>
        <div class="sub">
          <span class="pill" id="pill-status"><span id="statusDot" class="dot pulse"></span><span id="statusText">Connecting</span></span>
          <span class="pill" id="pill-powered">Powered by <a href="https://hydrapool.org/" target="_blank" rel="noopener noreferrer"><b>Hydra Pool</b></a></span>
          <span class="pill" id="lastUpdate">Last Update: —</span>
        </div>
      </div>
    </div>

    <div class="grid">

      <div class="card overview">
        <div class="cardInner">
          <div class="headRow">
            <div class="sectionTitle">Overview</div>
          </div>

          <div class="kpiGrid">
            <div class="kpiTile small">
              <i class="fa-solid fa-bolt kpiBgIcon"></i>
              <div class="kpiTileInner">
                <div class="label"><i class="fa-solid fa-bolt"></i> HASHRATE (5M)</div>
                <div class="value"><span id="hash5m">—</span><span class="unit" id="hash5mUnit"></span></div>
              </div>
            </div>

            <div class="kpiTile small">
              <i class="fa-solid fa-stopwatch kpiBgIcon"></i>
              <div class="kpiTileInner">
                <div class="label"><i class="fa-solid fa-stopwatch"></i> AVG HASHRATE (1H)</div>
                <div class="value"><span id="hash1h">—</span><span class="unit" id="hash1hUnit"></span></div>
              </div>
            </div>

            <div class="kpiTile">
              <i class="fa-solid fa-users kpiBgIcon"></i>
              <div class="kpiTileInner">
                <div class="label"><i class="fa-solid fa-users"></i> ACTIVE USERS</div>
                <div class="value"><span id="usersNow" style="padding-left:20px">—</span><span class="unit"></span></div>
              </div>
            </div>

            <div class="kpiTile">
              <i class="fa-solid fa-microchip kpiBgIcon"></i>
              <div class="kpiTileInner">
                <div class="label"><i class="fa-solid fa-microchip"></i> ACTIVE WORKERS</div>
                <div class="value"><span id="workersOnline" style="padding-left:20px">—</span><span class="unit"></span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="chartsRow">
        <div class="card trendCard">
          <div class="cardInner">
            <div class="headRow">
              <div class="sectionTitle">Hashrate History</div>
              <div class="meta" id="trendMeta">Last 6h</div>
            </div>

            <div class="canvasWrap">
              <canvas id="trendChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card pieCard">
          <div class="cardInner">
            <div class="headRow">
              <div class="sectionTitle">Miner Share</div>
              <div class="meta" id="pieMeta">Last 5m</div>
            </div>

            <div class="pieWrap">
              <div class="piePad">
                <canvas id="minersPie"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="donationsRow">

        <div class="card">
          <div class="cardInner" style="padding:22px 30px 40px 30px">
            <div class="headRow">
              <div class="sectionTitle centerTitle">Hashrate Donations</div>
            </div>

            <div class="copyLabel">Point your hashrate to:</div>
            <div class="copyField" data-copy="stratum+tcp://pool.256foundation.org:3333">
              <span>stratum+tcp://pool.256foundation.org:3333</span>
              <i class="fa-regular fa-copy"></i>
            </div>

            <div class="copyLabel" style="padding-top:10px">Set your stratum user to username.workername, e.g.:</div>
            <div class="copyField" data-copy="your_npub.bitaxe-1">
              <span>your_npub.bitaxe-1</span>
              <i class="fa-regular fa-copy"></i>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardInner" style="padding:22px 30px 40px 30px">
            <div class="headRow">
              <div class="sectionTitle centerTitle">Bitcoin Donations</div>
            </div>

            <div class="copyLabel">Send bitcoin directly to:</div>
            <div class="copyField" data-copy="bc1qce93hy5rhg02s6aeu7mfdvxg76x66pqqtrvzs3">
              <span>bc1qce93hy5rhg02s6aeu7mfdvxg76x66pqqtrvzs3</span>
              <i class="fa-regular fa-copy"></i>
            </div>

            <div class="copyLabel" style="padding-top:10px">Or donate via Lightning to:</div>
            <div class="copyField" data-copy="donate@256f.org">
              <span>donate@256f.org</span>
              <i class="fa-regular fa-copy"></i>
            </div>
          </div>
        </div>

      </div>

      <div class="card usersCard">
        <div class="cardInner">

          <div class="usersContentConstrainer">

            <div class="usersHeadRow">
              <div class="sectionTitle centerTitle" id="users-workers">Users + Workers</div>
              <div class="toggleContainer">
                <label class="chicToggle">
                  <input type="checkbox" id="groupUsersCheck" checked> <span class="track">
                    <span class="thumb"></span>
                  </span>
                  <span class="label">Group</span>
                </label>

                <label class="chicToggle">
                  <input type="checkbox" id="showIdleCheck">
                  <span class="track">
                    <span class="thumb"></span>
                  </span>
                  <span class="label">Show Idle</span>
                </label>
              </div>
            </div>

            <div class="filterBar">
              <div class="filterField">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input id="userFilter" type="text" autocomplete="off" spellcheck="false"
                  placeholder="filter by user / worker" />
              </div>
              <button id="filterReset" type="button" class="filterBtn" disabled>CLEAR</button>
            </div>

            <div class="list" id="usersList"></div>
            <div id="err" class="error"></div>

          </div></div>
      </div>

      <!-- Difficulty Leaderboard -->
       
      <div class="card leaderboardCard">
      <!-- <div class="card leaderboardCard" style="display:none"> -->
        <div class="cardInner">
          <div class="leaderboardContent">
            <div class="usersHeadRow">
              <div class="sectionTitle centerTitle">Difficulty Leaderboard</div>
            </div>
            <div class="leaderboardHeader" id="leaderboardHeader">
              <div>Rank</div>
              <div id="lbDiffHeader">Difficulty</div>
              <div>User<span class="lbWorkerName"> • Worker</span></div>
            </div>
            <div id="leaderboardList"></div>
          </div>
        </div>
      </div>

    </div><div class="narrowBlock">
      <div style="text-align:center; margin:0 auto; margin-top:60px">
        <span>Made with ❤️ by <a href="https://x.com/d_plus__plus/" target="_blank"><b>D++</b></a> for the <a href="https://256foundation.org/" target="_blank" rel="noopener noreferrer"><b>256 Foundation</b></a></span>
        <div style="padding-top:4px">Powered by <a href="https://hydrapool.org/" target="_blank" rel="noopener noreferrer"><b>Hydra Pool</b></a></div>
      </div>
    </div>

  </div><div id="hoverTip"></div>

  <script>
    /* =========================
        SURGICAL NOSTR ENGINE (NIP-19 + NIP-05)
    ========================= */
    const nostrPool = new window.NostrTools.SimplePool();
    const nostrRelays = ['wss://relay.damus.io', 'wss://nos.lol', 'wss://relay.snort.social', 'wss://relay.primal.net'];
    const profileCache = new Map(); // stores hex_pubkey -> profile
    const idToPubkey = new Map();   // stores identifier (npub or email) -> hex_pubkey

    // Twitter handle detection and avatar
    // Extract Twitter handle from string (e.g., "@dplusplus" -> "dplusplus")
    function extractTwitterHandle(str) {
      if (!str) return null;
      // Must start with @ and be alphanumeric/underscore only (Twitter rules)
      const match = str.match(/^@([A-Za-z0-9_]{1,15})$/);
      return match ? match[1] : null;
    }

    // Sanitize Twitter handle - only allow safe characters
    function sanitizeTwitterHandle(handle) {
      if (!handle) return null;
      // Strip anything that's not alphanumeric or underscore
      const clean = handle.replace(/[^A-Za-z0-9_]/g, '');
      // Twitter handles are max 15 chars
      return clean.slice(0, 15) || null;
    }

    // Get Twitter avatar URL via unavatar.io (just returns URL, image onerror handles failures)
    function getTwitterAvatarUrl(handle) {
      const clean = sanitizeTwitterHandle(handle);
      if (!clean) return null;
      return `https://unavatar.io/twitter/${encodeURIComponent(clean)}`;
    }

    // Resolves NIP-05 via HTTPS fetch to domain well-known path
async function resolveNIP05(fullname) {
  if (idToPubkey.has(fullname)) return idToPubkey.get(fullname);
  try {
    const [name, domain] = fullname.split('@');
    const res = await fetch(`https://${domain}/.well-known/nostr.json?name=${name}`);
    const data = await res.json();
    const pubkey = data.names[name];
    if (pubkey) {
      idToPubkey.set(fullname, pubkey);
      scheduleProfileRender();
    }
    return pubkey;
  } catch (e) { return null; }
}

    // Debounced re-render to prevent flicker when multiple profiles load
    let profileRenderTimer = null;
    function scheduleProfileRender() {
      if (profileRenderTimer) clearTimeout(profileRenderTimer);
      profileRenderTimer = setTimeout(() => {
        profileRenderTimer = null;
        renderUsersList(latestUserList);
        fetchLeaderboard(); // Re-fetch to get updated profile data
        updatePieLabels(); // Update pie chart labels with resolved profiles
      }, 300);
    }

    // Unified fetcher for any Nostr identifier (uses Primal API for speed)
    async function getProfile(identifier) {
      let pubkey = idToPubkey.get(identifier);

      if (!pubkey) {
        if (identifier.startsWith('npub1')) {
          try { pubkey = window.NostrTools.nip19.decode(identifier).data; } catch(e){}
        } else if (identifier.includes('@')) {
          pubkey = await resolveNIP05(identifier);
        }
        if (pubkey) idToPubkey.set(identifier, pubkey);
      }

      if (!pubkey) return null;
      if (profileCache.has(pubkey)) return profileCache.get(pubkey);

      try {
        // Use Primal's fast cached API instead of slow relay queries
        const res = await fetch(`https://primal.net/api/user_profile?pubkey=${pubkey}`);
        if (res.ok) {
          const data = await res.json();
          if (data && (data.display_name || data.name || data.picture)) {
            profileCache.set(pubkey, data);
            scheduleProfileRender();
            return data;
          }
        }
      } catch (e) { console.error("Primal API error:", e); }

      // Fallback to relay if Primal fails
      try {
        const event = await nostrPool.get(nostrRelays, { kinds: [0], authors: [pubkey] });
        if (event) {
          const profile = JSON.parse(event.content);
          profileCache.set(pubkey, profile);
          scheduleProfileRender();
          return profile;
        }
      } catch (e) { console.error("Relay fetch error:", e); }
      return null;
    }

    async function buildTooltipHtml(payload) {
      let headerBlock = "";

      // Helper to ensure pixel-perfect consistency across all tooltip icon types
      function getTooltipIcon(src, type, color, fallbackId) {
        const isWebsite = (type === 'website');
        const borderColor = color || (type === 'nostr' ? '#8c67ff' : 'var(--accent)');
        // Website icons get 7px padding to breathe; avatars get 0 to fill the circle
        const padding = isWebsite ? '7px' : '0px';
        const fit = isWebsite ? 'contain' : 'cover';

        return `
          <div style="position:relative; flex-shrink:0; width:46px; height:46px;">
            <div style="width:46px; height:46px; border-radius:50%; border:2px solid ${borderColor}; background:rgba(255,255,255,0.03); overflow:hidden; display:flex; align-items:center; justify-content:center; box-sizing:border-box;">
              <img src="${escapeHtml(src)}"
                ${type === 'nostr' ? `data-fallback="${escapeHtml(fallbackId)}"` : ''}
                onerror="this.onerror=null; ${type === 'website' ? `this.parentElement.innerHTML='<i class=\\'fa-solid fa-globe\\' style=\\'font-size:20px;color:${borderColor};\\'></i>'` : (type === 'twitter' ? `this.parentElement.innerHTML='<i class=\\'fa-brands fa-x-twitter\\' style=\\'font-size:20px;color:${borderColor};\\'></i>'` : `this.src='https://robohash.org/' + encodeURIComponent(this.dataset.fallback)` )};"
                style="width:100%; height:100%; object-fit:${fit}; padding:${padding}; box-sizing:border-box; display:block; border-radius:50%;">
            </div>
            <div style="position:absolute; bottom:-2px; right:-2px; background:${borderColor}; width:14px; height:14px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px solid #000;">
              <i class="fa-solid fa-link" style="font-size:7px; color:#fff;"></i>
            </div>
          </div>
        `;
      }

      const workerNostrId = payload.workerName?.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/)?.[0] || payload.workerName?.match(/npub1[a-z0-9]+/i)?.[0];
      const workerOwnUrl = !workerNostrId ? extractUrl(payload.workerName) : null;
      const combinedUrl = extractCombinedUrl(payload.ownerAddr, payload.workerName);
      const twitterHandle = payload.twitterHandle || extractTwitterHandle(payload.ownerAddr);
      const parentNostrId = payload.nostrId;
      const parentUrl = extractUrl(payload.ownerAddr);
      const websiteUrl = payload.websiteUrl || workerOwnUrl || combinedUrl || parentUrl;

      // 1. Worker Nostr
      if (workerNostrId) {
        const profile = await getProfile(workerNostrId);
        if (profile) {
          headerBlock = `
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.12);flex-wrap:wrap;">
              ${getTooltipIcon(ensureHttps(profile.picture) || '', 'nostr', '#8c67ff', workerNostrId)}
              <div style="display:flex;flex-direction:column;gap:1px;min-width:0;">
                <div style="font-weight:800;color:#fff;font-size:15px;letter-spacing:-0.01em;word-break:break-word;">
                  ${escapeHtml(profile.display_name || profile.name || 'Nostrich')}
                </div>
                <div style="font-size:9px;color:#8c67ff;font-family:var(--mono);font-weight:700;letter-spacing:1px;text-transform:uppercase;">NOSTR</div>
              </div>
            </div>`;
        }
      }
      // 2. Worker/Combined Website
      else if (workerOwnUrl || combinedUrl) {
        const url = workerOwnUrl || combinedUrl;
        const domain = url.replace(/^https?:\/\//, '').split('/')[0];
        headerBlock = `
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.12);flex-wrap:wrap;">
            ${getTooltipIcon(getFaviconUrl(url), 'website', 'var(--accent)')}
            <div style="display:flex;flex-direction:column;gap:1px;min-width:0;">
              <div style="font-weight:800;color:#fff;font-size:15px;letter-spacing:-0.01em;word-break:break-word;">${escapeHtml(domain)}</div>
              <div style="font-size:9px;color:var(--accent);font-family:var(--mono);font-weight:700;letter-spacing:1px;text-transform:uppercase;">WEBSITE</div>
            </div>
          </div>`;
      }
      // 3. Twitter
      else if (twitterHandle && !parentNostrId) {
        const cleanHandle = sanitizeTwitterHandle(twitterHandle);
        headerBlock = `
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.12);flex-wrap:wrap;">
            ${getTooltipIcon(getTwitterAvatarUrl(cleanHandle), 'twitter', 'var(--accent)')}
            <div style="display:flex;flex-direction:column;gap:1px;min-width:0;">
              <div style="font-weight:800;color:#fff;font-size:15px;letter-spacing:-0.01em;word-break:break-word;">@${escapeHtml(cleanHandle)}</div>
              <div style="font-size:9px;color:var(--accent);font-family:var(--mono);font-weight:700;letter-spacing:1px;text-transform:uppercase;">TWITTER</div>
            </div>
          </div>`;
      }
      // 4. Parent Nostr
      else if (parentNostrId) {
        const profile = await getProfile(parentNostrId);
        if (profile) {
          headerBlock = `
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.12);flex-wrap:wrap;">
              ${getTooltipIcon(ensureHttps(profile.picture) || '', 'nostr', '#8c67ff', parentNostrId)}
              <div style="display:flex;flex-direction:column;gap:1px;min-width:0;">
                <div style="font-weight:800;color:#fff;font-size:15px;letter-spacing:-0.01em;word-break:break-word;">
                  ${escapeHtml(profile.display_name || profile.name || 'Nostrich')}
                </div>
                <div style="font-size:9px;color:#8c67ff;font-family:var(--mono);font-weight:700;letter-spacing:1px;text-transform:uppercase;">NOSTR</div>
              </div>
            </div>`;
        }
      }
      // 5. General Website
      else if (websiteUrl) {
        const domain = websiteUrl.replace(/^https?:\/\//, '').split('/')[0];
        headerBlock = `
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.12);flex-wrap:wrap;">
            ${getTooltipIcon(getFaviconUrl(websiteUrl), 'website', 'var(--accent)')}
            <div style="display:flex;flex-direction:column;gap:1px;min-width:0;">
              <div style="font-weight:800;color:#fff;font-size:15px;letter-spacing:-0.01em;word-break:break-word;">${escapeHtml(domain)}</div>
              <div style="font-size:9px;color:var(--accent);font-family:var(--mono);font-weight:700;letter-spacing:1px;text-transform:uppercase;">WEBSITE</div>
            </div>
          </div>`;
      }

      return `
        <div style="width:100%;max-width:100%;">
          ${headerBlock}
          <div style="padding-left:2px;">
            <div style="font-family:var(--mono);font-weight:700;font-size:13px;color:rgba(255,255,255,0.95);word-break:break-word;">
              ${escapeHtml(payload.name)}
            </div>
            <div class="muted" style="margin-top:4px;font-size:11px;display:flex;align-items:center;gap:6px;flex-wrap:wrap;min-width:0;">
              <span style="font-size:100%;color:${payload.status === 'active' ? 'var(--good)' : 'var(--bad)'};">•</span>
              <span style="min-width:0;">${payload.status}</span>
              <span style="opacity:0.5;">|</span>
              <span style="min-width:0;">${payload.lastTxt}</span>
              ${payload.bestTxt ? `<span style="opacity:0.5;">|</span><span style="min-width:0;">${payload.bestTxt}</span>` : ''}
            </div>
          </div>
        </div>
      `;
    }

    /* =========================
        CONFIG
    ========================= */

    /* const PROM_BASE = "https://bolt12.dplus.plus/256"; */
const PROM_BASE = "https://pool.256foundation.org";


  


    const TREND_HOURS = 6;
    const TREND_STEP_SECONDS = 60;
    const ONE_HOUR_STEP_SECONDS = 60;

    const FAST_REFRESH_MS = 15 * 1000;
    const TREND_REFRESH_MS = 60 * 1000;

    const MAX_USERS = 1000;
    const MAX_WORKERS = 50000;
    const PIE_TOP_N = 8;

    // super chic worker collapse
    const WORKERS_COLLAPSED = 8;
    const expandedAddrs = new Set();

    // filter
    let latestUserList = [];
    let filterQuery = "";
    let filterTimer = null;

    // const promql = {
    //   /* hashrate5m: "sum(rate(worker_shares_valid_total[5m]))", */
    //   hashrate5m: "rate(accepted_difficulty_total[5m]) * 4294967296",

    //   usersHashrate5m: "sum by (btcaddress) (rate(worker_shares_valid_total[5m]))",
    //   usersHashrate5mActiveCount: "count(sum by (btcaddress) (rate(worker_shares_valid_total[5m])) > 0)",

    //   usersWorkers5m_workername: "sum by (btcaddress, workername) (rate(worker_shares_valid_total[5m]))",
    //   usersWorkers5m_worker: "sum by (btcaddress, worker) (rate(worker_shares_valid_total[5m]))",
    //   usersWorkers5m_rig: "sum by (btcaddress, rig) (rate(worker_shares_valid_total[5m]))",
    //   usersWorkers5m_name: "sum by (btcaddress, name) (rate(worker_shares_valid_total[5m]))",

    //   lastShare_workername: "max by (btcaddress, workername) (worker_last_share_at)",
    //   lastShare_worker: "max by (btcaddress, worker) (worker_last_share_at)",
    //   lastShare_rig: "max by (btcaddress, rig) (worker_last_share_at)",
    //   lastShare_name: "max by (btcaddress, name) (worker_last_share_at)",
    //   workerBestEver: "worker_best_share_ever"
    // };


    const promql = {
      hashrate5m: "rate(accepted_difficulty_total[5m]) * 4294967296",

      usersHashrate5m: "sum by (btcaddress) (rate(worker_shares_valid_total[5m])*1.8)",
      usersHashrate5mActiveCount: "count(sum by (btcaddress) (rate(worker_shares_valid_total[5m])*1.8) > 0)",

      usersWorkers5m_workername: "sum by (btcaddress, workername) (rate(worker_shares_valid_total[5m])*1.8)",
      usersWorkers5m_worker: "sum by (btcaddress, worker) (rate(worker_shares_valid_total[5m])*1.8)",
      usersWorkers5m_rig: "sum by (btcaddress, rig) (rate(worker_shares_valid_total[5m])*1.8)",
      usersWorkers5m_name: "sum by (btcaddress, name) (rate(worker_shares_valid_total[5m])*1.8)",

      lastShare_workername: "max by (btcaddress, workername) (worker_last_share_at)",
      lastShare_worker: "max by (btcaddress, worker) (worker_last_share_at)",
      lastShare_rig: "max by (btcaddress, rig) (worker_last_share_at)",
      lastShare_name: "max by (btcaddress, name) (worker_last_share_at)",
      workerBestEver: "worker_best_share_ever"
    };

    function isMobile(){
      return window.innerWidth <= 620;
    }

    /* =========================
        PROM API
    ========================= */

    function promQuery(q){
      return $.ajax({
        url: PROM_BASE + "/api/v1/query",
        method: "POST",
        data: "query=" + encodeURIComponent(q),
        contentType: "application/x-www-form-urlencoded; charset=UTF-8"
      });
    }

    function promQueryRange(q, startSec, endSec, stepSec){
      const body =
        "query=" + encodeURIComponent(q) +
        "&start=" + encodeURIComponent(startSec) +
        "&end=" + encodeURIComponent(endSec) +
        "&step=" + encodeURIComponent(stepSec);

      return $.ajax({
        url: PROM_BASE + "/api/v1/query_range",
        method: "POST",
        data: body,
        contentType: "application/x-www-form-urlencoded; charset=UTF-8"
      });
    }

    function okResult(resp){
      return resp && resp.status === "success" && resp.data && resp.data.result;
    }

    function scalarValue(resp){
      if (!okResult(resp)) return NaN;
      const r = resp.data.result;
      if (!r.length || !r[0].value) return NaN;
      const v = parseFloat(r[0].value[1]);
      return isFinite(v) ? v : NaN;
    }

    function series(resp){
      if (!okResult(resp)) return [];
      return resp.data.result || [];
    }

    async function promQueryFirst(list){
      for (let i = 0; i < list.length; i++){
        try{
          const resp = await promQuery(list[i]);
          const s = series(resp);
          if (s && s.length) return { q: list[i], resp: resp };
        } catch(_){}
      }
      return { q: "", resp: null };
    }

    /* =========================
        HELPERS
    ========================= */

    function mean(xs){
      if (!xs || !xs.length) return NaN;
      let s = 0;
      for (let i = 0; i < xs.length; i++) s += xs[i];
      return s / xs.length;
    }

    function median(xs){
      if (!xs || !xs.length) return NaN;
      const a = xs.slice().sort(function(a,b){ return a - b; });
      const mid = Math.floor(a.length / 2);
      if (a.length % 2) return a[mid];
      return (a[mid - 1] + a[mid]) / 2;
    }

    function mad(xs, med){
      if (!xs || !xs.length) return NaN;
      const m = isFinite(med) ? med : median(xs);
      const dev = [];
      for (let i = 0; i < xs.length; i++) dev.push(Math.abs(xs[i] - m));
      return median(dev);
    }

    function fmtInt(n){
      if (!isFinite(n)) return "—";
      return Math.round(n).toLocaleString();
    }

    function toTHs(hPerSec){
      return hPerSec / 1e12;
    }

    function humanHashrateFromHps(hPerSec, decimals = 1) {
      if (!isFinite(hPerSec)) return { value: "—", unit: "" };
      const abs = Math.abs(hPerSec);
      if (abs >= 1e18) return { value: (hPerSec / 1e18).toFixed(decimals), unit: "EH/s" };
      if (abs >= 1e15) return { value: (hPerSec / 1e15).toFixed(decimals), unit: "PH/s" };
      if (abs >= 1e12) return { value: (hPerSec / 1e12).toFixed(decimals), unit: "TH/s" };
      if (abs >= 1e9)  return { value: (hPerSec / 1e9).toFixed(decimals), unit: "GH/s" };
      if (abs >= 1e6)  return { value: (hPerSec / 1e6).toFixed(decimals), unit: "MH/s" };
      if (abs >= 1e3)  return { value: (hPerSec / 1e3).toFixed(decimals), unit: "KH/s" };
      return { value: Math.round(hPerSec).toString(), unit: "H/s" };
    }

    function fmtTime(tsSec){
      const d = new Date(tsSec * 1000);
      return d.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
    }

    function fmtDateTime(d){
      return d.toLocaleString([], { year:"numeric", month:"numeric", day:"numeric", hour:"numeric", minute:"2-digit", second:"2-digit" });
    }

    // Upgrade http:// URLs to https:// to avoid mixed content warnings
    function ensureHttps(url) {
      if (!url) return url;
      return url.replace(/^http:\/\//i, 'https://');
    }

    // Track highlighted user for re-renders
    let highlightedAddr = null;
    let highlightStartTime = null;

    // Scroll to user in the list and highlight them
    function scrollToUser(addr) {
      if (!addr || addr === "other") return;

      // Track highlight immediately so re-renders can pick it up
      highlightedAddr = addr;
      highlightStartTime = Date.now() + 500; // Offset by scroll delay

      // Clear search filter if active
      if (filterQuery.length > 0) {
        $("#userFilter").val("");
        filterQuery = "";
        $("#filterReset").prop("disabled", true);
      }

      // Switch to grouped mode if not already (pie chart shows grouped users)
      const $groupCheck = $("#groupUsersCheck");
      const wasUngrouped = !$groupCheck.is(":checked");
      if (wasUngrouped) {
        $groupCheck.prop("checked", true).trigger("change");
      }

      // Wait for re-render if we switched modes
      setTimeout(() => {
        const row = document.querySelector(`.row[data-addr="${CSS.escape(addr)}"]`);
        if (!row) return;

        const listContainer = document.getElementById('usersList');
        if (!listContainer) return;

        // Scroll the list container to show the row
        const rowTop = row.offsetTop;
        const containerHeight = listContainer.clientHeight;
        const scrollTarget = Math.max(0, rowTop - containerHeight / 3);
        listContainer.scrollTo({ top: scrollTarget, behavior: 'smooth' });

        // Scroll page to users card
        const usersCard = document.querySelector('.usersCard');
        if (usersCard) {
          usersCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Flash highlight after scroll completes
        setTimeout(() => {
          highlightStartTime = Date.now(); // Reset to actual start time

          const currentRow = document.querySelector(`.row[data-addr="${CSS.escape(addr)}"]`);
          if (!currentRow) return;

          currentRow.classList.remove('highlight-flash');
          void currentRow.offsetWidth; // Force reflow
          currentRow.classList.add('highlight-flash');

          // Clean up class when animation ends
          currentRow.addEventListener('animationend', function handler() {
            currentRow.classList.remove('highlight-flash');
            currentRow.removeEventListener('animationend', handler);
            highlightedAddr = null;
            highlightStartTime = null;
          });
        }, 500);
      }, wasUngrouped ? 100 : 0);
    }

    // Track highlighted "other" users for re-renders
    let highlightedOtherAddrs = [];
    let highlightOtherStartTime = null;

    // Scroll to and highlight all "other" miners (those beyond PIE_TOP_N)
    function scrollToOtherUsers() {
      // Get the addresses of miners in the "other" category (stored when pie data was set)
      const otherAddrs = pieOtherAddrs;
      if (!otherAddrs || otherAddrs.length === 0) return;

      // Track highlights immediately so re-renders can pick them up
      highlightedOtherAddrs = otherAddrs;
      highlightOtherStartTime = Date.now() + 500; // Offset by scroll delay

      // Clear search filter if active
      if (filterQuery.length > 0) {
        $("#userFilter").val("");
        filterQuery = "";
        $("#filterReset").prop("disabled", true);
      }

      // Switch to grouped mode if not already (pie chart shows grouped users)
      const $groupCheck = $("#groupUsersCheck");
      const wasUngrouped = !$groupCheck.is(":checked");
      if (wasUngrouped) {
        $groupCheck.prop("checked", true).trigger("change");
      }

      // Wait for re-render if we switched modes
      setTimeout(() => {
        // Find the first "other" user row to scroll to
        const firstOtherAddr = otherAddrs[0];
        const firstRow = document.querySelector(`.row[data-addr="${CSS.escape(firstOtherAddr)}"]`);

        const listContainer = document.getElementById('usersList');
        if (!listContainer) return;

        if (firstRow) {
          // Scroll the list container to show the first "other" row
          const rowTop = firstRow.offsetTop;
          const containerHeight = listContainer.clientHeight;
          const scrollTarget = Math.max(0, rowTop - containerHeight / 3);
          listContainer.scrollTo({ top: scrollTarget, behavior: 'smooth' });
        }

        // Scroll page to users card
        const usersCard = document.querySelector('.usersCard');
        if (usersCard) {
          usersCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Flash highlight on all "other" rows after scroll completes
        setTimeout(() => {
          highlightOtherStartTime = Date.now(); // Reset to actual start time

          let animationsRemaining = 0;
          otherAddrs.forEach(addr => {
            const row = document.querySelector(`.row[data-addr="${CSS.escape(addr)}"]`);
            if (!row) return;

            animationsRemaining++;
            row.classList.remove('highlight-flash');
            void row.offsetWidth; // Force reflow
            row.classList.add('highlight-flash');

            // Clean up class when animation ends
            row.addEventListener('animationend', function handler() {
              row.classList.remove('highlight-flash');
              row.removeEventListener('animationend', handler);
              animationsRemaining--;
              if (animationsRemaining === 0) {
                highlightedOtherAddrs = [];
                highlightOtherStartTime = null;
              }
            });
          });
        }, 500);
      }, wasUngrouped ? 100 : 0);
    }

    function shortAddr(a){
      if (!a) return "—";
      if (a.length <= 16) return a;
      return a.slice(0, 10) + "…" + a.slice(-10);
    }

    function superShortAddr(a){
      if (!a) return "—";
      if (a.length <= 12) return a;
      return a.slice(0, 6) + "…" + a.slice(-4);
    }

    // Smart truncate: middle truncate for npub/bitcoin addresses, trail off for regular names
    function smartTruncate(a, maxLen = 30){
      if (!a) return "—";
      if (a.length <= maxLen) return a;
      // Check if it looks like an npub or bitcoin address
      const isNpub = /^npub1[a-z0-9]+$/i.test(a);
      const isBitcoin = /^(bc1|[13])[a-zA-Z0-9]{25,}$/.test(a);
      if (isNpub || isBitcoin) {
        // Middle truncate - split maxLen between start and end
        const sideLen = Math.floor((maxLen - 1) / 2);
        return a.slice(0, sideLen) + "…" + a.slice(-sideLen);
      }
      // Regular name - trail off at end
      return a.slice(0, maxLen - 1) + "…";
    }

    // Pie chart label: resolve npub to profile name, middle-truncate bitcoin, end-truncate regular strings
    function getPieLabel(addr, mobile) {
      if (!addr) return "—";
      const isNpub = /^npub1[a-z0-9]+$/i.test(addr);
      const isBitcoin = /^(bc1|[13])[a-zA-Z0-9]{25,}$/.test(addr);

      // If it's an npub, try to resolve to profile name
      if (isNpub) {
        const hex = idToPubkey.get(addr);
        if (hex) {
          const profile = profileCache.get(hex);
          if (profile && (profile.display_name || profile.name)) {
            const name = profile.display_name || profile.name;
            // Longer limit for resolved profile names
            const maxLen = mobile ? 24 : 50;
            if (name.length <= maxLen) return name;
            return name.slice(0, maxLen - 1) + "…";
          }
        }
        // Npub not resolved yet, middle-truncate
        return mobile ? superShortAddr(addr) : shortAddr(addr);
      }

      // Bitcoin address: middle-truncate
      if (isBitcoin) {
        return mobile ? superShortAddr(addr) : shortAddr(addr);
      }

      // Check if string contains an embedded npub or NIP-05
      const embeddedNostrId = addr.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/)?.[0]
                           || addr.match(/npub1[a-z0-9]+/i)?.[0];
      if (embeddedNostrId) {
        const hex = idToPubkey.get(embeddedNostrId);
        if (hex) {
          const profile = profileCache.get(hex);
          if (profile && (profile.display_name || profile.name)) {
            const name = profile.display_name || profile.name;
            const maxLen = mobile ? 24 : 50;
            if (name.length <= maxLen) return name;
            return name.slice(0, maxLen - 1) + "…";
          }
        }
      }

      // Regular string: longer limit, only truncate crazy long names
      const maxLen = mobile ? 24 : 50;
      if (addr.length <= maxLen) return addr;
      return addr.slice(0, maxLen - 1) + "…";
    }

    function getWorkerName(metric){
      if (!metric) return "";
      if (metric.workername) return metric.workername;
      if (metric.worker) return metric.worker;
      if (metric.rig) return metric.rig;
      if (metric.name) return metric.name;
      return "";
    }

    function niceColorPalette(n){
      const base = [
        "#38a6ff","#8c67ff","#39d98a","#ffd36a","#ff5b7a","#25c4ff",
        "#ff8a3d","#7cf7ff","#b7ff6a","#ff63d8","#7a5cff","#00f5a0",
        "#ffe66a","#ff4d6d","#4de2ff","#9dff57"
      ];
      const out = [];
      for (let i = 0; i < n; i++) out.push(base[i % base.length]);
      return out;
    }

    function escapeHtml(s){
      return String(s || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Get favicon URL for a domain via icon.horse (generates letter fallback if no favicon)
    function getFaviconUrl(url) {
      if (!url) return null;
      try {
        const domain = url.replace(/^https?:\/\//, '').split('/')[0];
        const clean = domain.replace(/[^a-zA-Z0-9.-]/g, '');
        if (!clean) return null;
        return `https://icon.horse/icon/${encodeURIComponent(clean)}`;
      } catch (e) { return null; }
    }

    // Detect URL-like patterns in names (e.g., "dplusplusDOTcom", "foo_dot_org", "example.com")
    // BUT NOT NIP-05 identifiers (user@domain.com) - those should go to Nostr
    function extractUrl(str) {
      if (!str) return null;
      // Skip if it looks like a NIP-05 (contains @)
      if (str.includes('@')) return null;
      // Normalize: replace DOT, _dot_, -dot-, etc with actual dots
      const normalized = str
        .replace(/[_\-]?dot[_\-]?/gi, '.')
        .replace(/DOT/g, '.');
      // Match domain-like pattern (word.tld)
      const match = normalized.match(/([a-zA-Z0-9][-a-zA-Z0-9]*\.)+[a-zA-Z]{2,}/i);
      if (match) {
        return 'https://' + match[0].toLowerCase();
      }
      return null;
    }

    // Edge case: user "SovereignHybridCompute" + worker "com" = "SovereignHybridCompute.com"
    // Some folks split their domain across username.workername by accident
    // Only triggers if workername is an actual TLD
    function extractCombinedUrl(username, workername) {
      if (!username || !workername) return null;
      const tlds = ['com','org','net','io','co','dev','app','xyz','info','biz','me','tv','cc','gg','ai','tech','online','site','store','shop','plus'];
      if (!tlds.includes(workername.toLowerCase())) return null;
      const combined = username + '.' + workername;
      return extractUrl(combined);
    }

    // Wrap name in link if URL found, with optional fallback URL (for worker inheriting from user)
    function linkifyName(name, fallbackUrl) {
      const ownUrl = extractUrl(name);
      const url = ownUrl || fallbackUrl;
      if (url) {
        return `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(name)}</a>`;
      }
      return escapeHtml(name);
    }

    function getNostrNameForAddr(addr) {
      // Extract nostr identifier from address
      const nostrId = addr.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/)?.[0]
                   || addr.match(/npub1[a-z0-9]+/i)?.[0];
      if (!nostrId) return null;

      // Get hex pubkey from identifier
      const hex = idToPubkey.get(nostrId);
      if (!hex) return null;

      // Get profile from cache
      const profile = profileCache.get(hex);
      if (!profile) return null;

      // Return searchable name string (display_name and name)
      return [profile.display_name, profile.name].filter(Boolean).join(' ').toLowerCase();
    }

    function applyFilter(list, q){
      const t = String(q || "").trim().toLowerCase();
      if (!t) return list;

      return list.filter(function(u){
        // Search by raw address (npub, NIP-05, etc.)
        if ((u.addr || "").toLowerCase().includes(t)) return true;

        // Search by resolved Nostr profile name
        const nostrName = getNostrNameForAddr(u.addr);
        if (nostrName && nostrName.includes(t)) return true;

        // Search by worker names
        const ws = u.workers || [];
        for (let i = 0; i < ws.length; i++){
          if ((ws[i].name || "").toLowerCase().includes(t)) return true;

          // Also check if worker name contains a nostr identifier
          const workerNostrName = getNostrNameForAddr(ws[i].name);
          if (workerNostrName && workerNostrName.includes(t)) return true;
        }
        return false;
      });
    }

    function animateListScrollToRowBottom($row){
      const $scroller = $("#usersList");
      if (!$scroller.length || !$row.length) return;

      const rowTop = $row.position().top;
      const rowBottom = rowTop + $row.outerHeight(true);
      const viewH = $scroller.height();
      const curTop = $scroller.scrollTop();

      const pad = 18;
      const target = Math.max(0, rowBottom - viewH + pad);

      if (target > curTop + 2){
        $scroller.stop(true).animate({ scrollTop: target }, 260);
      }
    }

    /* =========================
        1H AVG FIX
    ========================= */

    async function refreshHash1hFromSamples(){
      const end = Math.floor(Date.now() / 1000);
      const start = end - 3600;

      const resp = await promQueryRange(promql.hashrate5m, start, end, ONE_HOUR_STEP_SECONDS);
      const s = series(resp);
      if (!s.length || !s[0].values || !s[0].values.length) return NaN;

      const xs = s[0].values
        .map(function(v){ return parseFloat(v[1]); })
        .filter(function(v){ return isFinite(v) && v >= 0; });

      if (!xs.length) return NaN;

      const med = median(xs);
      const m = mad(xs, med);

      if (!isFinite(m) || m < 1e-12){
        return toTHs(mean(xs));
      }

      const sigma = m * 1.4826;
      const K = 8;
      const lo = med - K * sigma;
      const hi = med + K * sigma;

      const filtered = xs.filter(function(v){ return v >= lo && v <= hi; });
      const use = filtered.length >= Math.max(6, Math.floor(xs.length * 0.5)) ? filtered : xs;

      return toTHs(mean(use));
    }

    /* =========================
        TREND SMOOTHING
    ========================= */

    function weightedMovingAverage(points) {
      if (!points || points.length < 2) return points;
      const clean = points.filter(p => isFinite(p.v) && p.v >= 0);
      if (clean.length < 2) return clean;
      const windowSize = 3; 
      const out = [];

      for (let i = 0; i < clean.length; i++) {
        let sumW = 0;
        let sumV = 0;
        for (let j = 0; j < windowSize; j++) {
           if (i - j < 0) break;
           const w = windowSize - j;
           sumW += w;
           sumV += clean[i - j].v * w;
        }
        if (sumW > 0) out.push({ t: clean[i].t, v: sumV / sumW });
        else out.push(clean[i]);
      }
      return out;
    }

    /* =========================
        TOOLTIP (Desktop hover + iOS-safe mobile tap)
    ========================= */

    const $hoverTip = $("#hoverTip");

    let tipPinnedUntil = 0;
    let tipPinTimer = null;
    let lastTapShowAt = 0;

    function pinHoverTip(ms){
      const dur = Math.max(0, (ms|0));
      tipPinnedUntil = Date.now() + dur;

      if (tipPinTimer) clearTimeout(tipPinTimer);
      if (dur){
        tipPinTimer = setTimeout(function(){
          hideHoverTip(true);
        }, dur);
      }
    }

    function showHoverTip(html, x, y, pinMs){
      $hoverTip.html(html);

      const pad = 12;

      const nx = (typeof x === "number" && isFinite(x)) ? x : Math.floor(window.innerWidth / 2);
      const ny = (typeof y === "number" && isFinite(y)) ? y : 90;

      // read AFTER html set (helps iOS sizing weirdness)
      const tipW = $hoverTip.outerWidth();
      const tipH = $hoverTip.outerHeight();

      let left = nx + 14;
      let top  = ny + 14;

      // flip if needed
      if (left + tipW + pad > window.innerWidth) left = nx - tipW - 14;
      if (top + tipH + pad > window.innerHeight) top = ny - tipH - 14;

      // hard clamp (prevents off-screen even if coords are odd)
      left = Math.max(pad, Math.min(left, window.innerWidth - tipW - pad));
      top  = Math.max(pad, Math.min(top,  window.innerHeight - tipH - pad));

      $hoverTip.css({
        left: Math.round(left) + "px",
        top:  Math.round(top) + "px"
      }).addClass("show");

      if (pinMs) pinHoverTip(pinMs);
    }

    function hideHoverTip(force){
      if (force === true){
        tipPinnedUntil = 0;
      } else {
        if (Date.now() < tipPinnedUntil) return; // prevents iOS “flash then disappear”
      }
      $hoverTip.removeClass("show");
    }

    function tapPointOrEl(e, el){
      const oe = (e && e.originalEvent) ? e.originalEvent : e;

      const t =
        (oe && oe.touches && oe.touches.length) ? oe.touches[0] :
        (oe && oe.changedTouches && oe.changedTouches.length) ? oe.changedTouches[0] :
        null;

      const x = (oe && typeof oe.clientX === "number") ? oe.clientX : (t ? t.clientX : NaN);
      const y = (oe && typeof oe.clientY === "number") ? oe.clientY : (t ? t.clientY : NaN);

      if (isFinite(x) && isFinite(y) && x > 0 && y > 0) return { x:x, y:y };

      if (el && el.getBoundingClientRect){
        const r = el.getBoundingClientRect();
        return { x: r.left + (r.width/2), y: r.top + Math.min(24, r.height/2) };
      }

      return { x: Math.floor(window.innerWidth/2), y: 90 };
    }

    function wireWorkerHover($el, payload) {
      // Desktop hover
      $el.on("mouseenter", async function(e) {
        if (isMobile()) return;
        const html = await buildTooltipHtml(payload);
        showHoverTip(html, e.clientX, e.clientY);
      });

      $el.on("mousemove", function(e) {
        if (isMobile() || !$("#hoverTip").hasClass("show")) return;
        const tip = $("#hoverTip");
        let left = e.clientX + 14;
        let top = e.clientY + 14;
        tip.css({ left: left, top: top });
      });

      $el.on("mouseleave", function() {
        hideHoverTip(true);
      });

      // Mobile tap
      $el.on("touchstart pointerdown", async function(e) {
        if (!isMobile()) return;
        const pt = tapPointOrEl(e, $el[0]);
        const html = await buildTooltipHtml(payload);
        showHoverTip(html, pt.x, pt.y - 22, 5000);
      });
    }

    /* =========================
        COPY-TO-CLIPBOARD
    ========================= */

    function pointerXY(e){
      const oe = e && e.originalEvent ? e.originalEvent : e;
      const t = oe && oe.touches && oe.touches.length ? oe.touches[0] : null;
      const x = (typeof e.clientX === "number") ? e.clientX : (t ? t.clientX : Math.floor(window.innerWidth / 2));
      const y = (typeof e.clientY === "number") ? e.clientY : (t ? t.clientY : 90);
      return { x:x, y:y };
    }

    function flashCopiedTip(x, y){
      showHoverTip("<div><b>Copied to clipboard!</b></div>", x, y);
      setTimeout(hideHoverTip, 650);
    }

    function wireCopyFields(){
      $(document).on("click", ".copyField", async function(e){
        const text = $(this).attr("data-copy") || $(this).text();
        const p = pointerXY(e);

        try{
          await navigator.clipboard.writeText(text);
          flashCopiedTip(p.x, p.y);
        } catch(_){
          const $tmp = $("<textarea>").val(text).css({
            position:"fixed", left:"-9999px", top:"-9999px", opacity:"0"
          });
          $("body").append($tmp);
          $tmp[0].select();
          document.execCommand("copy");
          $tmp.remove();
          flashCopiedTip(p.x, p.y);
        }
      });
    }

    /* =========================
        CHARTS
    ========================= */

    let trendChart;
    let minersPie;

    let pieFullAddrs = [];
    let pieOtherAddrs = [];
    let pieTotalTH = 0;

    function initTrendChart(){
      const ctx = document.getElementById("trendChart").getContext("2d");

      function trendGradient(chart){
        const area = chart.chartArea;
        if (!area) return "rgba(56,166,255,0.18)";
        const g = chart.ctx.createLinearGradient(0, area.top, 0, area.bottom);
        g.addColorStop(0, "rgba(56,166,255,0.55)");
        g.addColorStop(1, "rgba(56,166,255,0.00)");
        return g;
      }

      trendChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label: "Hashrate (TH/s)",
            data: [],
            borderColor: getComputedStyle(document.documentElement).getPropertyValue("--accent").trim(),
            backgroundColor: function(c){
              return trendGradient(c.chart);
            },
            fill: true,
            borderWidth: 2.5,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: "#fff",
            tension: 0.25
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: {
              labels: {
                color: "rgba(255,255,255,.78)",
                font: { family: getComputedStyle(document.documentElement).getPropertyValue("--mono").trim(), size: 13 },
                padding: 18,
                usePointStyle: true,
                pointStyle: "line"
              }
            },
            tooltip: {
              backgroundColor: "rgba(0,0,0,.72)",
              borderColor: "rgba(255,255,255,.18)",
              borderWidth: 1,
              titleColor: "rgba(255,255,255,.92)",
              bodyColor: "rgba(255,255,255,.92)",
              titleFont: { family: getComputedStyle(document.documentElement).getPropertyValue("--mono").trim(), size: 13 },
              bodyFont: { family: getComputedStyle(document.documentElement).getPropertyValue("--mono").trim(), size: 13 },
              callbacks: {
                label: function(ctx){
                  const v = ctx.parsed.y;
                  const label = trendChart.data.datasets[0].label || "";
                  const mult = label.includes("EH") ? 1e18 : label.includes("PH") ? 1e15 : 1e12;
                  const hr = humanHashrateFromHps(v * mult, 1);
                  return ` Hashrate: ${hr.value} ${hr.unit}`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: "rgba(255,255,255,.55)",
                maxRotation: 0,
                autoSkip: true,
                autoSkipPadding: 18,
                font: { family: getComputedStyle(document.documentElement).getPropertyValue("--mono").trim(), size: 12 }
              },
              grid: { color: "rgba(255,255,255,.07)" }
            },
            y: {
              ticks: {
                color: "rgba(255,255,255,.55)",
                padding: 8,
                font: { family: getComputedStyle(document.documentElement).getPropertyValue("--mono").trim(), size: 12 },
                // callback: function(v){ return v.toLocaleString(undefined, {maximumFractionDigits: 1}); }
callback: function(v){ return v.toLocaleString(undefined, {maximumFractionDigits: v < 10 ? 1 : 0}); }
                // callback: function(v){ return Math.floor(v).toLocaleString(); }
              },
              grid: { color: "rgba(255,255,255,.07)" }
            }
          }
        }
      });
    }

    function setTrendData(pointsTH){
      const labels = [];
      const data = [];

      for (let i = 0; i < pointsTH.length; i++){
        labels.push(new Date(pointsTH[i].t).toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" }));
        data.push(pointsTH[i].v);
      }

      trendChart.data.labels = labels;
      trendChart.data.datasets[0].data = data;
      trendChart.update("none");
    }

    // CUSTOM PIE TOOLTIP HANDLER (External)
    const pieTooltipHandler = (context) => {
      // Tooltip Element
      let tooltipEl = document.getElementById('hoverTip');

      const { chart, tooltip } = context;

      // Hide if no tooltip
      if (tooltip.opacity === 0) {
        tooltipEl.classList.remove('show');
        return;
      }

      // Set Text
      if (tooltip.body) {
        const dataPoints = tooltip.dataPoints;
        if(dataPoints && dataPoints.length > 0) {
          const idx = dataPoints[0].dataIndex;
          const dataset = chart.data.datasets[0];

          const rawVal = dataset.data[idx];
          const activeCount = dataset.activeCounts[idx];

          const pct = (pieTotalTH > 0) ? ((rawVal / pieTotalTH) * 100) : 0;
          const addr = pieFullAddrs[idx] || "";
          // Resolve npub to profile name for tooltip
          let userTitle = addr === "other" ? "Other" : addr;
          const pureNpub = /^npub1[a-z0-9]+$/i.test(addr);
          const embeddedNostrId = addr.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/)?.[0]
                               || addr.match(/npub1[a-z0-9]+/i)?.[0];
          const nostrId = pureNpub ? addr : embeddedNostrId;
          if (nostrId) {
            const hex = idToPubkey.get(nostrId);
            if (hex) {
              const profile = profileCache.get(hex);
              if (profile && (profile.display_name || profile.name)) {
                userTitle = profile.display_name || profile.name;
              }
            }
          }

          const plural = activeCount > 1 ? 's' : '';

          // Use color dot from the chart data
          const color = dataset.backgroundColor[idx];

          // Construct HTML
          const phr = humanHashrateFromHps(rawVal * 1e12, 1);
          let innerHtml = `
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                <div style="width:10px;height:10px;border-radius:50%;background:${color};box-shadow:0 0 6px ${color};"></div>
                <div style="font-weight:700;font-size:13px;max-width:310px; overflow:hidden;text-overflow:ellipsis;">${escapeHtml(userTitle)}</div>
            </div>
            <div class="muted">
                ${phr.value} ${phr.unit} • ${pct.toFixed(1)}% • ${activeCount} active worker${plural}
            </div>
          `;

          tooltipEl.innerHTML = innerHtml;
        }
      }

      // Position logic (Responsive Clamping)
      const rect = chart.canvas.getBoundingClientRect();
      const tipW = tooltipEl.offsetWidth;
      const tipH = tooltipEl.offsetHeight;
      const pad = 12;

      // Target position: caretX/Y are relative to chart canvas area
      let left = rect.left + tooltip.caretX + 14; 
      let top = rect.top + tooltip.caretY;

      // Clamp to viewport
      // If goes off right edge, flip to left
      if (left + tipW + pad > window.innerWidth) {
         left = rect.left + tooltip.caretX - tipW - 14;
      }
      // If goes off left edge (after flipping or initially), clamp to 10px
      if (left < 10) left = 10;

      // If goes off bottom, flip up
      if (top + tipH + pad > window.innerHeight) {
          top = rect.top + tooltip.caretY - tipH - 10;
      }

      tooltipEl.style.left = left + 'px';
      tooltipEl.style.top = top + 'px';
      tooltipEl.classList.add('show');
    };

    function initMinersPie(){
      const ctx = document.getElementById("minersPie").getContext("2d");
      minersPie = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: [],
          datasets: [{
            data: [],
            activeCounts: [],
            backgroundColor: [],
            borderColor: "rgba(255,255,255,.10)",
            borderWidth: 1,
            hoverOffset: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          cutout: "64%",
          onClick: function(e, elements) {
            if (elements.length > 0) {
              const index = elements[0].index;
              if (pieFullAddrs[index] === "other") {
                scrollToOtherUsers();
              } else {
                scrollToUser(pieFullAddrs[index]);
              }
            }
          },
          onHover: function(e, elements) {
            const canvas = e.native.target;
            if (elements.length > 0) {
              canvas.style.cursor = "pointer";
            } else {
              canvas.style.cursor = "default";
            }
          },
          plugins: {
            legend: {
              display: false,
              position: "bottom",
              title: {
                display: true,
                text: " ",   // A space forces the block to render
                padding: 4  ,  // The text height itself (~12px) acts as the 10px spacer
              },

              onClick: function(e, legendItem, legend) {
                 const index = legendItem.index;
                 if (pieFullAddrs[index] === "other") {
                   scrollToOtherUsers();
                 } else {
                   scrollToUser(pieFullAddrs[index]);
                 }
              },
              onHover: function(e, legendItem, legend) {
                e.native.target.style.cursor = "pointer";
              },
              onLeave: function(e, legendItem, legend) {
                e.native.target.style.cursor = "default";
              },
              labels: {
                color: "rgba(255,255,255,.78)",
                font: { family: getComputedStyle(document.documentElement).getPropertyValue("--mono").trim(), size: 11 },
                padding: 10,
                usePointStyle: true,
                pointStyle: "circle"
              }
            },
            tooltip: {
              enabled: false, // Use custom handler
              external: pieTooltipHandler
            }
          }
        }
      });
    }

    function setPieLegendForViewport(){
      const mobile = isMobile();
      if (minersPie){
        minersPie.options.plugins.legend.display = mobile;
        minersPie.update("none");
      }
    }

    function setPieData(minersSorted){
      const labels = [];
      const valsTH = [];
      const activeCounts = [];
      pieFullAddrs = [];
      pieOtherAddrs = minersSorted.slice(PIE_TOP_N).map(m => m.addr);

      const top = minersSorted.slice(0, PIE_TOP_N);
      let otherHps = 0;
      let otherActive = 0;

      for (let i = PIE_TOP_N; i < minersSorted.length; i++){
        otherHps += minersSorted[i].totalHps;
        const workers = minersSorted[i].workers || [];
        for(let w=0; w<workers.length; w++) {
           if(workers[w].active) otherActive++;
        }
      }

      for (let j = 0; j < top.length; j++){
        labels.push(getPieLabel(top[j].addr, isMobile()));
        pieFullAddrs.push(top[j].addr);
        valsTH.push(toTHs(top[j].totalHps));

        let active = 0;
        const workers = top[j].workers || [];
        for(let w=0; w<workers.length; w++) {
           if(workers[w].active) active++;
        }
        activeCounts.push(active);
      }

      if (minersSorted.length > PIE_TOP_N){
        labels.push("Other");
        pieFullAddrs.push("other");
        valsTH.push(toTHs(otherHps));
        activeCounts.push(otherActive);
      }

      pieTotalTH = 0;
      for (let k = 0; k < valsTH.length; k++) pieTotalTH += valsTH[k];

      const colors = niceColorPalette(labels.length);

      minersPie.data.labels = labels;
      minersPie.data.datasets[0].data = valsTH;
      minersPie.data.datasets[0].backgroundColor = colors;
      minersPie.data.datasets[0].activeCounts = activeCounts;
      minersPie.update("none");

      // Trigger profile fetches for any npubs in the pie chart
      for (let j = 0; j < top.length; j++) {
        const addr = top[j].addr;
        if (/^npub1[a-z0-9]+$/i.test(addr) && !idToPubkey.has(addr)) {
          getProfile(addr);
        }
      }
    }

    // Update pie chart labels when profiles are resolved
    function updatePieLabels() {
      if (!minersPie || !pieFullAddrs || pieFullAddrs.length === 0) return;
      const mobile = isMobile();
      const newLabels = pieFullAddrs.map(addr => {
        if (addr === "other") return "Other";
        return getPieLabel(addr, mobile);
      });
      minersPie.data.labels = newLabels;
      minersPie.update("none");
    }

    /* =========================
        REFRESH
    ========================= */

    async function refreshOverview(){
      $("#err").text("");

      try{
        const upResp = await promQuery("up");
        const online = (scalarValue(upResp) === 1);

        $("#statusDot").toggleClass("bad", !online);
        $("#statusText").text(online ? "Online" : "Offline");

        const hash5mResp = await promQuery(promql.hashrate5m);
        const hash5mHps = scalarValue(hash5mResp);

        const hr = humanHashrateFromHps(hash5mHps);
        $("#hash5m").text(hr.value);
        $("#hash5mUnit").text(hr.unit);

        const hash1hTH = await refreshHash1hFromSamples();
        if (isFinite(hash1hTH)){
          const hr1 = humanHashrateFromHps(hash1hTH * 1e12);
          $("#hash1h").text(hr1.value);
          $("#hash1hUnit").text(hr1.unit);
        } else {
          $("#hash1h").text("—");
          $("#hash1hUnit").text("");
        }

        const usersNowResp = await promQuery(promql.usersHashrate5mActiveCount);
        $("#usersNow").text(fmtInt(scalarValue(usersNowResp)));

        const now = new Date();
        $("#lastUpdate").text("Last Update: " + fmtDateTime(now));

      } catch (e){
        $("#statusDot").addClass("bad");
        $("#statusText").text("error");
        $("#err").text("overview error: " + (e?.statusText || e?.message || "unknown"));
      }
    }

    async function refreshUsersWorkersAndPie(){
      $("#err").text("");

      try{
        const totalsResp = await promQuery(promql.usersHashrate5m);
        const totalsSeries = series(totalsResp);

        const workersPick = await promQueryFirst([
          promql.usersWorkers5m_workername,
          promql.usersWorkers5m_worker,
          promql.usersWorkers5m_rig,
          promql.usersWorkers5m_name
        ]);
        const workersSeries = workersPick.resp ? series(workersPick.resp) : [];

        const lastPick = await promQueryFirst([
          promql.lastShare_workername,
          promql.lastShare_worker,
          promql.lastShare_rig,
          promql.lastShare_name
        ]);
        const lastSeries = lastPick.resp ? series(lastPick.resp) : [];

        const bestEverResp = await promQuery(promql.workerBestEver);
        const bestEverSeries = series(bestEverResp);
        const bestEverMap = {};
        for (let i = 0; i < bestEverSeries.length; i++) {
          const m = bestEverSeries[i].metric || {};
          const addr = m.btcaddress || "";
          const w = getWorkerName(m);
          const v = bestEverSeries[i].value ? parseFloat(bestEverSeries[i].value[1]) : NaN;
          if (addr && w && isFinite(v)) bestEverMap[addr + "|" + w] = v;
        }

        const lastMap = {};
        for (let i = 0; i < lastSeries.length; i++){
          const metric = lastSeries[i].metric || {};
          const addr = metric.btcaddress || "";
          const w = getWorkerName(metric);
          const t = lastSeries[i].value ? parseFloat(lastSeries[i].value[1]) : NaN;
          if (!addr || !w || !isFinite(t)) continue;
          lastMap[addr + "|" + w] = t;
        }

        const nowSec = Math.floor(Date.now() / 1000);

        const users = {};

        for (let i = 0; i < totalsSeries.length; i++){
          const addr = totalsSeries[i].metric?.btcaddress || "";
          const v = totalsSeries[i].value ? parseFloat(totalsSeries[i].value[1]) : NaN;
          if (!addr || !isFinite(v)) continue;

          if (!users[addr]) users[addr] = { addr: addr, totalHps: 0, workers: [] };
          users[addr].totalHps = v;
        }

        for (let k = 0; k < workersSeries.length; k++){
          const metric = workersSeries[k].metric || {};
          const addr = metric.btcaddress || "";
          const wName = getWorkerName(metric);
          const v = workersSeries[k].value ? parseFloat(workersSeries[k].value[1]) : NaN;
          if (!addr || !wName || !isFinite(v)) continue;

          if (!users[addr]) users[addr] = { addr: addr, totalHps: 0, workers: [] };

          const last = lastMap[addr + "|" + wName];
          const active = isFinite(last) ? ((nowSec - last) <= 300) : (v > 0);
          const best = bestEverMap[addr + "|" + wName];

          users[addr].workers.push({ name: wName, hps: v, last: last, active: active, best: best });
        }

        const userList = [];
        for (const a in users) userList.push(users[a]);
        userList.sort(function(a,b){ return b.totalHps - a.totalHps; });

        latestUserList = userList.slice();

        setPieData(userList);

        let workersOnlineNow = 0;
        for (let m = 0; m < userList.length; m++){
          for (let w = 0; w < userList[m].workers.length; w++){
            if (userList[m].workers[w].active) workersOnlineNow++;
          }
        }
        $("#workersOnline").text(fmtInt(workersOnlineNow));

        renderUsersList(latestUserList);

        // Fetch and render difficulty leaderboard
        fetchLeaderboard();

      } catch (e){
        $("#err").text("users/workers error: " + (e?.statusText || e?.message || "unknown"));
      }
    }

    async function refreshTrend(){
      $("#err").text("");

      try{
        const end = Math.floor(Date.now() / 1000);
        const start = end - (TREND_HOURS * 3600);

        const resp = await promQueryRange(promql.hashrate5m, start, end, TREND_STEP_SECONDS);
        const s = series(resp);
        if (!s.length || !s[0].values || !s[0].values.length){
          setTrendData([]);
          return;
        }

        const raw = [];
        for (let i = 0; i < s[0].values.length; i++){
          const ts = s[0].values[i][0];
          const v = parseFloat(s[0].values[i][1]);
          if (!isFinite(v) || v < 0) continue;
          raw.push({ t: ts * 1000, v: v });
        }

        const smooth = weightedMovingAverage(raw);

        const smoothScaled = [];
        if (smooth.length > 0) {
          const latest = smooth[smooth.length - 1].v;
          const hr = humanHashrateFromHps(latest, 1);
          trendChart.data.datasets[0].label = `Hashrate (${hr.unit})`;

          const divisors = { "EH/s": 1e18, "PH/s": 1e15, "TH/s": 1e12, "GH/s": 1e9, "MH/s": 1e6, "KH/s": 1e3 };
          const divisor = divisors[hr.unit] || 1;

          for (let j = 0; j < smooth.length; j++) {
            smoothScaled.push({ t: smooth[j].t, v: smooth[j].v / divisor });
          }
        }
        setTrendData(smoothScaled);

      } catch (e){
        $("#err").text("trend error: " + (e?.statusText || e?.message || "unknown"));
      }
    }

    /* =========================
        DIFFICULTY LEADERBOARD
    ========================= */

    async function fetchLeaderboard() {
      try {
        // Fetch both queries
        const [bestResp, workersResp] = await Promise.all([
          $.get(PROM_BASE + "/api/v1/query?query=best_share_ever"),
          $.get(PROM_BASE + "/api/v1/query?query=topk(10,worker_best_share_ever)")
        ]);

        const bestData = series(bestResp);
        const poolBestValue = bestData.length > 0 && bestData[0].value ? parseFloat(bestData[0].value[1]) : 0;

        const workersData = series(workersResp);
        const topWorkerValue = workersData.length > 0 && workersData[0].value ? parseFloat(workersData[0].value[1]) : 0;

        // Only show pool best row if it's higher than top worker
        const showPoolBest = poolBestValue > topWorkerValue;

        renderDifficultyLeaderboard(workersData, showPoolBest ? poolBestValue : null);
      } catch (e) {
        console.error("Leaderboard fetch error:", e);
      }
    }

    function renderDifficultyLeaderboard(data, poolBestValue) {
      const $list = $("#leaderboardList");
      $list.empty();

      // If pool best is higher than top worker, add it as #1
      if (poolBestValue && isFinite(poolBestValue) && poolBestValue > 0) {
        const $row = $("<div>").addClass("leaderboardRow");
        const $rank = $("<div>").addClass("lbRank medal").text("🥇");
        const $diff = $("<div>").addClass("lbDiff").html(formatDifficultyHtml(poolBestValue));
        const $user = $("<div>").addClass("lbUser").html(`
          <div style="display:flex;align-items:center;gap:10px;min-width:0;">
            <div style="width:24px;height:24px;border-radius:50%;border:2px solid #ffd700;background:rgba(255,215,0,0.1);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
              <i class="fa-solid fa-trophy" style="font-size:10px;color:#ffd700;margin-top:1px;"></i>
            </div>
            <span class="lbUserName" style="color:rgba(255,255,255,.6);font-style:italic;">Jungly plz expose 🙏</span>
          </div>
        `);
        $row.append($rank, $diff, $user);
        $list.append($row);
      }

      // Build array from series data
      const entries = [];
      for (let i = 0; i < data.length; i++) {
        const m = data[i].metric || {};
        const val = data[i].value;
        const diff = val ? parseFloat(val[1]) : NaN;
        if (!isFinite(diff) || diff <= 0) continue;

        const addr = m.btcaddress || "";
        const workerName = getWorkerName(m);

        entries.push({
          addr: addr,
          workerName: workerName,
          difficulty: diff
        });
      }

      // Sort by difficulty descending (should already be sorted but just in case)
      entries.sort((a, b) => b.difficulty - a.difficulty);

      // Take top 9 if showing pool best, otherwise top 10
      const topEntries = entries.slice(0, poolBestValue ? 9 : 10);

      // Render each row
      const startRank = poolBestValue ? 2 : 1; // Start at #2 if pool best is shown as #1
      for (let i = 0; i < topEntries.length; i++) {
        const entry = topEntries[i];
        const rank = i + startRank;

        // Build user/worker display with avatar
        const $row = $("<div>").addClass("leaderboardRow");

        // Rank with medals for top 3
        const $rank = $("<div>").addClass("lbRank");
        if (rank === 2 && poolBestValue) {
          $rank.addClass("medal").text("🥈");
        } else if (rank === 3 && poolBestValue) {
          $rank.addClass("medal").text("🥉");
        } else if (rank === 1) {
          $rank.addClass("medal").text("🥇");
        } else if (rank === 2) {
          $rank.addClass("medal").text("🥈");
        } else if (rank === 3) {
          $rank.addClass("medal").text("🥉");
        } else {
          $rank.text(rank);
        }

        // Difficulty
        const $diff = $("<div>").addClass("lbDiff").html(formatDifficultyHtml(entry.difficulty));

        // User/Worker with avatar
        const $user = $("<div>").addClass("lbUser");
        const workerDisplay = entry.workerName && entry.workerName !== "unnamed" ? entry.workerName : "";

        // Check for identity types (same logic as users list)
        const twitterHandle = extractTwitterHandle(entry.addr);
        const userUrl = !twitterHandle ? extractUrl(entry.addr) : null;
        const nostrId = !twitterHandle && !userUrl ? (entry.addr.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/)?.[0] || entry.addr.match(/npub1[a-z0-9]+/i)?.[0]) : null;

        // Build avatar and link
        if (twitterHandle) {
          const cleanHandle = sanitizeTwitterHandle(twitterHandle);
          const avatarUrl = getTwitterAvatarUrl(cleanHandle);
          const twitterUrl = `https://x.com/${encodeURIComponent(cleanHandle)}`;
          const nameHtml = workerDisplay ? `@${escapeHtml(cleanHandle)} <span class="lbWorkerName">• ${escapeHtml(workerDisplay)}</span>` : `@${escapeHtml(cleanHandle)}`;
          $user.append(`
            <a href="${escapeHtml(twitterUrl)}" target="_blank" rel="noopener noreferrer" style="display:flex;align-items:center;gap:10px;text-decoration:none;min-width:0;">
              <div style="position:relative;flex-shrink:0;">
                <img src="${escapeHtml(avatarUrl)}" onerror="this.onerror=null; this.parentElement.innerHTML='<div style=\\'width:24px;height:24px;border-radius:50%;border:2px solid var(--accent);background:rgba(56,166,255,0.1);display:flex;align-items:center;justify-content:center;\\'><i class=\\'fa-brands fa-x-twitter\\' style=\\'font-size:10px;color:var(--accent);\\'></i></div>';"
                  style="width:24px;height:24px;border-radius:50%;border:2px solid var(--accent);object-fit:cover;">
              </div>
              <span class="lbUserName">${nameHtml}</span>
            </a>
          `);
        } else if (userUrl) {
          const faviconUrl = getFaviconUrl(userUrl);
          const domain = userUrl.replace(/^https?:\/\//, '').split('/')[0];
          const nameHtml = workerDisplay ? `${escapeHtml(domain)} <span class="lbWorkerName">• ${escapeHtml(workerDisplay)}</span>` : escapeHtml(domain);
          $user.append(`
            <a href="${escapeHtml(userUrl)}" target="_blank" rel="noopener noreferrer" style="display:flex;align-items:center;gap:10px;text-decoration:none;min-width:0;">
              <div style="position:relative;flex-shrink:0;">
                <img src="${escapeHtml(faviconUrl)}" onerror="this.onerror=null; this.parentElement.innerHTML='<div style=\\'width:24px;height:24px;border-radius:50%;border:2px solid var(--accent);background:rgba(56,166,255,0.1);display:flex;align-items:center;justify-content:center;\\'><i class=\\'fa-solid fa-globe\\' style=\\'font-size:10px;color:var(--accent);\\'></i></div>';"
                  style="width:24px;height:24px;border-radius:50%;border:2px solid var(--accent);object-fit:cover;">
              </div>
              <span class="lbUserName">${nameHtml}</span>
            </a>
          `);
        } else if (nostrId) {
          const profile = profileCache.get(idToPubkey.get(nostrId));
          const hex = idToPubkey.get(nostrId);
          const npub = hex ? window.NostrTools.nip19.npubEncode(hex) : (nostrId.startsWith('npub1') ? nostrId : null);
          const profileUrl = npub ? `https://primal.net/p/${encodeURIComponent(npub)}` : null;
          const picUrl = ensureHttps(profile?.picture) || `https://robohash.org/${encodeURIComponent(nostrId)}`;
          const userName = profile?.display_name || profile?.name || smartTruncate(entry.addr, 18);
          const nameHtml = workerDisplay ? `${escapeHtml(userName)} <span class="lbWorkerName">• ${escapeHtml(workerDisplay)}</span>` : escapeHtml(userName);

          if (profileUrl) {
            $user.append(`
              <a href="${escapeHtml(profileUrl)}" target="_blank" style="display:flex;align-items:center;gap:10px;text-decoration:none;min-width:0;">
                <div style="position:relative;flex-shrink:0;">
                  <img src="${escapeHtml(picUrl)}" onerror="this.src='https://robohash.org/${encodeURIComponent(nostrId)}'"
                    style="width:24px;height:24px;border-radius:50%;border:2px solid #9d80fb;object-fit:cover;background:#000;">
                </div>
                <span class="lbUserName">${nameHtml}</span>
              </a>
            `);
          } else {
            $user.append(`
              <div style="display:flex;align-items:center;gap:10px;min-width:0;">
                <div style="position:relative;flex-shrink:0;">
                  <img src="${escapeHtml(picUrl)}" style="width:24px;height:24px;border-radius:50%;border:2px solid #9d80fb;object-fit:cover;background:#000;">
                </div>
                <span class="lbUserName">${nameHtml}</span>
              </div>
            `);
          }
          getProfile(nostrId); // Trigger fetch if not cached
        } else {
          // Check if worker name is a TLD - if so, combine user + worker to form URL
          const tlds = ['com', 'org', 'net', 'io', 'co', 'dev', 'xyz', 'info', 'biz', 'me', 'tv', 'cc', 'us', 'uk', 'de', 'fr', 'es', 'it', 'nl', 'be', 'ch', 'at', 'au', 'ca', 'jp', 'cn', 'in', 'br', 'ru', 'pl', 'se', 'no', 'fi', 'dk', 'cz', 'pt', 'gr', 'hu', 'ro', 'bg', 'hr', 'sk', 'si', 'lt', 'lv', 'ee'];
          const workerLower = workerDisplay.toLowerCase();

          if (workerDisplay && tlds.includes(workerLower)) {
            // Worker is a TLD - combine to form website URL, but keep bullet convention
            const domain = `${entry.addr}.${workerLower}`;
            const siteUrl = `https://${domain}`;
            const faviconUrl = getFaviconUrl(siteUrl);
            const nameHtml = `${escapeHtml(entry.addr)} <span class="lbWorkerName">• ${escapeHtml(workerDisplay)}</span>`;
            $user.append(`
              <a href="${escapeHtml(siteUrl)}" target="_blank" rel="noopener noreferrer" style="display:flex;align-items:center;gap:10px;text-decoration:none;min-width:0;">
                <div style="position:relative;flex-shrink:0;">
                  <img src="${escapeHtml(faviconUrl)}" onerror="this.onerror=null; this.parentElement.innerHTML='<div style=\\'width:24px;height:24px;border-radius:50%;border:2px solid var(--accent);background:rgba(56,166,255,0.1);display:flex;align-items:center;justify-content:center;\\'><i class=\\'fa-solid fa-globe\\' style=\\'font-size:10px;color:var(--accent);\\'></i></div>';"
                    style="width:24px;height:24px;border-radius:50%;border:2px solid var(--accent);object-fit:cover;">
                </div>
                <span class="lbUserName">${nameHtml}</span>
              </a>
            `);
          } else {
            // Plain user - just show hammer icon placeholder
            const userDisplay = entry.addr;
            const nameHtml = workerDisplay ? `${escapeHtml(userDisplay)} <span class="lbWorkerName">• ${escapeHtml(workerDisplay)}</span>` : escapeHtml(userDisplay);
            $user.append(`
              <div style="display:flex;align-items:center;gap:10px;min-width:0;">
                <div style="width:24px;height:24px;border-radius:50%;border:2px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                  <i class="fa-solid fa-hammer" style="font-size:9px;color:rgba(255,255,255,0.35);"></i>
                </div>
                <span class="lbUserName">${nameHtml}</span>
              </div>
            `);
          }
        }

        $row.append($rank, $diff, $user);
        $list.append($row);
      }

      // If no entries at all
      if (topEntries.length === 0 && !poolBestValue) {
        $list.append('<div style="text-align:center;padding:20px;color:rgba(255,255,255,.5);">No difficulty data yet</div>');
      }

    }

    function formatDifficulty(diff) {
      if (diff >= 1e12) return { value: (diff / 1e12).toFixed(2), unit: "T" };
      if (diff >= 1e9) return { value: (diff / 1e9).toFixed(2), unit: "G" };
      if (diff >= 1e6) return { value: (diff / 1e6).toFixed(2), unit: "M" };
      if (diff >= 1e3) return { value: (diff / 1e3).toFixed(2), unit: "K" };
      return { value: diff.toFixed(0), unit: "" };
    }

    function formatDifficultyHtml(diff) {
      const d = formatDifficulty(diff);
      return `<span class="lbDiffNum">${d.value}</span><span style="font-size:0.4em;"> </span><span class="lbDiffUnit">${d.unit}</span>`;
    }

    /* =========================
        RENDER USERS LIST
    ========================= */

    function renderUsersList(list){
      const $list = $("#usersList");
      $list.empty();

      // Check toggles
      const showIdle = $("#showIdleCheck").is(":checked");
      const groupUsers = $("#groupUsersCheck").is(":checked"); 
      const isFiltering = filterQuery.length > 0;

      const effectiveShowIdle = showIdle || isFiltering;

      // MODE 1: GROUPED
      if (groupUsers) {
        const processedUsers = [];
        for(let i=0; i<list.length; i++) {
            const user = list[i];
            const allWorkers = user.workers || [];
            const visibleWorkers = allWorkers.filter(w => effectiveShowIdle || w.active);

            if (!effectiveShowIdle && visibleWorkers.length === 0) continue;

            const processedUser = Object.assign({}, user);
            processedUser.workers = visibleWorkers;
            processedUser.workers.sort(function(a,b){ 
                if(a.active && !b.active) return -1;
                if(!a.active && b.active) return 1;
                return b.hps - a.hps; 
            });
            processedUsers.push(processedUser);
        }

        const filtered = applyFilter(processedUsers, filterQuery);
        const topUsers = filtered.slice(0, MAX_USERS);

        for (let n = 0; n < topUsers.length; n++){
          const u = topUsers[n];
          // const totalHr = humanHashrateFromHps(u.totalHps, 1);
          // const totalHr = humanHashrateFromHps(u.totalHps, u.totalHps >= 1e12 ? 1 : 0);

          const totalHr = humanHashrateFromHps(u.totalHps, 1);
if (u.totalHps < 1e12) {
  totalHr.value = Math.floor(parseFloat(totalHr.value)).toString();
}


          let activeCount = 0;
          for(let w=0; w<u.workers.length; w++) if(u.workers[w].active) activeCount++;

          const $row = $("<div>").addClass("row").attr("data-addr", u.addr);
          const $top = $("<div>").addClass("minerTop");

          // MISSION CRITICAL: Instant Link for Parent
          const twitterHandle = extractTwitterHandle(u.addr);
          const parentNostrId = !twitterHandle ? (u.addr.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/)?.[0] || u.addr.match(/npub1[a-z0-9]+/i)?.[0]) : null;
          const isMobileNarrow = window.innerWidth < 540;
          const isExtraNarrow = window.innerWidth <= 420;
          const isSuperNarrow = window.innerWidth < 385;
          // For non-bitcoin/non-npub addresses, only truncate if actually needed
          const isBitcoinOrNpub = /^(bc1|[13])[a-zA-Z0-9]{25,}$/.test(u.addr) || /^npub1[a-z0-9]+$/i.test(u.addr);
          // Single worker users get less aggressive truncation since we hide the total hashrate
          const isSingleWorker = u.workers.length === 1;
          // Bitcoin/npub addresses get short truncation, names get longer truncation
          // Single worker users get more space since hashrate is hidden on mobile
          // Multi-worker at <=420px needs slightly shorter truncation to fit hashrate on same line
          const truncateLenShort = isSuperNarrow ? (isSingleWorker ? 22 : 16) : (isExtraNarrow ? (isSingleWorker ? 24 : 20) : (isSingleWorker ? 32 : 25));
          const truncateLenLong = isSuperNarrow ? 28 : (isExtraNarrow ? 32 : 45);
          const truncateLen = isBitcoinOrNpub ? truncateLenShort : truncateLenLong;
          // Only truncate if it's a long bitcoin/npub address OR if the name actually exceeds truncateLen
          const shouldTruncate = isMobileNarrow && (isBitcoinOrNpub || u.addr.length > truncateLen);
          let addrHtml = escapeHtml(shouldTruncate ? smartTruncate(u.addr, truncateLen) : u.addr);
          let hasNostrProfile = false;
          let hasTwitterProfile = false;
          let resolvedNpub = null;

          if (twitterHandle) {
            // Twitter handle detected
            hasTwitterProfile = true;
            const cleanHandle = sanitizeTwitterHandle(twitterHandle);
            const avatarUrl = getTwitterAvatarUrl(cleanHandle);
            const twitterUrl = `https://x.com/${encodeURIComponent(cleanHandle)}`;

            addrHtml = `
              <a href="${escapeHtml(twitterUrl)}" target="_blank" rel="noopener noreferrer" style="display:flex;align-items:center;gap:10px;text-decoration:none;">
                <div style="position:relative;flex-shrink:0;">
                  <img src="${escapeHtml(avatarUrl)}" onerror="this.onerror=null; this.parentElement.innerHTML='<div style=\\'width:28px;height:28px;border-radius:50%;border:2px solid var(--accent);background:rgba(56,166,255,0.1);display:flex;align-items:center;justify-content:center;\\'><i class=\\'fa-brands fa-x-twitter\\' style=\\'font-size:12px;color:var(--accent);\\'></i></div><div style=\\'position:absolute;bottom:-2px;right:-2px;background:var(--accent);width:12px;height:12px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:1px solid #000;\\'><i class=\\'fa-solid fa-link\\' style=\\'font-size:6px;color:#fff;\\'></i></div>';"
                    style="width:28px;height:28px;border-radius:50%;border:2px solid var(--accent);object-fit:cover;background:#000;display:block;">
                  <div style="position:absolute;bottom:-2px;right:-2px;background:var(--accent);width:12px;height:12px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:1px solid #000;">
                    <i class="fa-solid fa-link" style="font-size:6px;color:#fff;"></i>
                  </div>
                </div>
                <div style="display:flex;flex-direction:column;gap:1px;">
                  <span style="color:rgba(255,255,255,.90);">${escapeHtml(u.addr)}</span>
                  <span style="font-size:9px;color:var(--accent);font-family:var(--mono);font-weight:700;letter-spacing:1px;text-transform:uppercase;">TWITTER</span>
                </div>
              </a>`;
          } else if (parentNostrId) {
            const hex = idToPubkey.get(parentNostrId);
            resolvedNpub = hex ? window.NostrTools.nip19.npubEncode(hex) : (parentNostrId.startsWith('npub1') ? parentNostrId : null);
            const profile = hex ? profileCache.get(hex) : null;

            if (profile && resolvedNpub) {
              // Show avatar + display name inline instead of npub
              hasNostrProfile = true;
              const displayName = escapeHtml(profile.display_name || profile.name || 'Nostrich');
              const avatarUrl = escapeHtml(ensureHttps(profile.picture) || '');
              const fallbackId = escapeHtml(parentNostrId);
              addrHtml = `
                <a href="https://primal.net/p/${encodeURIComponent(resolvedNpub)}" target="_blank" style="display:flex;align-items:center;gap:10px;text-decoration:none;">
                  <div style="position:relative;flex-shrink:0;">
                    <img src="${avatarUrl}" data-fallback="${fallbackId}" onerror="this.onerror=null; this.src='https://robohash.org/' + encodeURIComponent(this.dataset.fallback)"
                      style="width:28px;height:28px;border-radius:50%;border:2px solid #9d80fb;object-fit:cover;background:#000;display:block;">
                    <div style="position:absolute;bottom:-2px;right:-2px;background:#9d80fb;width:12px;height:12px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:1px solid #000;">
                      <i class="fa-solid fa-link" style="font-size:6px;color:#fff;"></i>
                    </div>
                  </div>
                  <div style="display:flex;flex-direction:column;gap:1px;">
                    <span style="color:rgba(255,255,255,.90);">${displayName}</span>
                    <span style="font-size:9px;color:#9d80fb;font-family:var(--mono);font-weight:700;letter-spacing:1px;text-transform:uppercase;">NOSTR</span>
                  </div>
                </a>`;
            } else if (resolvedNpub) {
              // Loading state - muted placeholder
              addrHtml = `
                <a href="https://primal.net/p/${encodeURIComponent(resolvedNpub)}" target="_blank" style="display:flex;align-items:center;gap:10px;text-decoration:none;">
                  <div style="position:relative;flex-shrink:0;">
                    <div style="width:28px;height:28px;border-radius:50%;border:2px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;">
                      <i class="fa-solid fa-hammer" style="font-size:11px;color:rgba(255,255,255,0.35);"></i>
                    </div>
                  </div>
                  <span style="color:rgba(255,255,255,.90);">${escapeHtml(isMobileNarrow ? smartTruncate(u.addr, truncateLen) : u.addr)}</span>
                </a>`;
              getProfile(parentNostrId);
            }
          } else {
            // No nostr ID - check for URL in username
            // Also check edge case: username + workername might form a URL (e.g., "SovereignHybridCompute" + "com")
            let userUrl = extractUrl(u.addr);
            if (!userUrl && u.workers && u.workers.length > 0) {
              for (let wi = 0; wi < u.workers.length; wi++) {
                userUrl = extractCombinedUrl(u.addr, u.workers[wi].name);
                if (userUrl) break;
              }
            }
            const displayAddr = escapeHtml(isMobileNarrow ? smartTruncate(u.addr, truncateLen) : u.addr);
            if (userUrl) {
              // Has URL - make clickable with favicon + link badge
              const faviconUrl = getFaviconUrl(userUrl);
              addrHtml = `
                <a href="${escapeHtml(userUrl)}" target="_blank" rel="noopener noreferrer" style="display:flex;align-items:center;gap:10px;text-decoration:none;">
                  <div style="position:relative;flex-shrink:0;">
                    <img src="${escapeHtml(faviconUrl)}" onerror="this.onerror=null; this.parentElement.innerHTML='<div style=\\'width:32px;height:32px;border-radius:50%;border:2px solid var(--accent);background:rgba(56,166,255,0.1);display:flex;align-items:center;justify-content:center;\\'><i class=\\'fa-solid fa-globe\\' style=\\'font-size:12px;color:var(--accent);\\'></i></div><div style=\\'position:absolute;bottom:-2px;right:-2px;background:var(--accent);width:12px;height:12px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:1px solid #000;\\'><i class=\\'fa-solid fa-link\\' style=\\'font-size:6px;color:#fff;\\'></i></div>';"
                      style="width:32px;height:32px;border-radius:50%;border:2px solid var(--accent);object-fit:contain;background:rgba(56,166,255,0.1);display:block;padding:4px;box-sizing:border-box;">
                    <div style="position:absolute;bottom:-2px;right:-2px;background:var(--accent);width:12px;height:12px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:1px solid #000;">
                      <i class="fa-solid fa-link" style="font-size:6px;color:#fff;"></i>
                    </div>
                  </div>
                  <div style="display:flex;flex-direction:column;gap:1px;">
                    <span style="color:rgba(255,255,255,.90);">${displayAddr}</span>
                    <span style="font-size:9px;color:var(--accent);font-family:var(--mono);font-weight:700;letter-spacing:1px;text-transform:uppercase;">WEBSITE</span>
                  </div>
                </a>`;
            } else {
              // No URL - muted placeholder
              addrHtml = `
                <div style="display:flex;align-items:center;gap:10px;">
                  <div style="position:relative;flex-shrink:0;">
                    <div style="width:28px;height:28px;border-radius:50%;border:2px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;">
                      <i class="fa-solid fa-hammer" style="font-size:11px;color:rgba(255,255,255,0.35);"></i>
                    </div>
                  </div>
                  <span style="color:rgba(255,255,255,.90);">${displayAddr}</span>
                </div>`;
            }
          }

          const $addr = $("<div>").addClass("addr").html(addrHtml);

          // Grouped mode: show status on hover (since avatar/name already visible)
          if (hasNostrProfile || hasTwitterProfile) {
            const statusTxt = activeCount > 0 ? "active" : "idle";
            const workersTxt = activeCount === 1 ? "1 active worker" : (activeCount + " active workers");
            $addr.on("mouseenter", function(e){
              const tipHtml = `
                <div style="font-family:var(--mono);font-size:12px;">
                  <div style="margin-bottom:6px;color:rgba(255,255,255,.70);">${escapeHtml(u.addr)}</div>
                  <div style="display:flex;align-items:center;gap:6px;">
                    <span style="color:${statusTxt === 'active' ? 'var(--good)' : 'var(--bad)'};">•</span>
                    <span>${statusTxt}</span>
                    <span style="opacity:0.5;">|</span>
                    <span>${workersTxt}</span>
                  </div>
                </div>`;
              showHoverTip(tipHtml, e.clientX, e.clientY);
            }).on("mouseleave", function(){ hideHoverTip(true); });
          } else if (parentNostrId) {
            wireWorkerHover($addr, {
              status: activeCount > 0 ? "active" : "idle",
              lastTxt: activeCount === 1 ? "1 active worker" : (activeCount + " active workers"),
              name: u.addr,
              nostrId: parentNostrId
            });
          } else {
            $addr.on("mouseenter", function(e){
                const txt = activeCount === 1 ? "1 active worker" : (activeCount + " active workers");
                showHoverTip(`<div><b>${txt}</b></div>`, e.clientX, e.clientY);
            }).on("mouseleave", function(){ hideHoverTip(true); });
          }

          const $hash = $("<div>").addClass("totalHash").text(totalHr.value + " " + totalHr.unit);
          if (u.workers.length === 1 && window.innerWidth <= 620) {
            $hash.addClass("hideSingleWorker");
          }
          $top.append($addr, $hash);

          const $wrap = $("<div>").addClass("workersWrap");
          const $workers = $("<div>").addClass("workers");
          const $extra = $("<div>").addClass("workersExtra");

          const workersToShow = isFiltering ? u.workers : u.workers.slice(0, MAX_WORKERS);
          const shouldCollapse = !isFiltering && (workersToShow.length > WORKERS_COLLAPSED) && !expandedAddrs.has(u.addr);
          if (shouldCollapse) $workers.addClass("collapsed");

          if (workersToShow.length){
            for (let j = 0; j < workersToShow.length; j++){
              const w = workersToShow[j];
              const $line = createWorkerLine(w, w.name, u.addr, parentNostrId);
              if (j < WORKERS_COLLAPSED) $workers.append($line);
              else $extra.append($line);
            }
            if (workersToShow.length > WORKERS_COLLAPSED){
              $workers.append($extra);
              const hiddenCount = workersToShow.length - WORKERS_COLLAPSED;
              if (!isFiltering) {
                  const $toggleRow = $("<div>").addClass("workersToggleRow");
                  const $btn = $("<button>").attr("type", "button").addClass("toggleMore");
                  function renderToggle(){
                    const open = expandedAddrs.has(u.addr);
                    if (open) $btn.html(`VIEW LESS <i class='fa-solid fa-caret-up'></i>`);
                    else $btn.html(`VIEW <span class='count'>${hiddenCount}</span> MORE <i class='fa-solid fa-caret-down'></i>`);
                  }
                  renderToggle();
                  $btn.on("click", function(){
                    hideHoverTip(true);
                    if (expandedAddrs.has(u.addr)) expandedAddrs.delete(u.addr);
                    else expandedAddrs.add(u.addr);
                    $workers.toggleClass("collapsed", !expandedAddrs.has(u.addr));
                    renderToggle();
                    if (expandedAddrs.has(u.addr)) requestAnimationFrame(() => animateListScrollToRowBottom($row));
                  });
                  $toggleRow.append($btn);
                  $wrap.append($workers, $toggleRow);
              } else $wrap.append($workers);
            } else $wrap.append($workers);
          } else {
             $workers.append(createEmptyWorkerLine());
             $wrap.append($workers);
          }
          $row.append($top, $wrap);
          $list.append($row);
        }
        if (filterQuery && !topUsers.length) $list.append(createNoMatchRow(filterQuery));

      } else {
        // MODE 2: FLAT LIST
        let allWorkers = [];
        for(let i=0; i<list.length; i++){
          const user = list[i];
          if(user.workers) user.workers.forEach(w => {
            const worker = Object.assign({}, w);
            worker.owner = user.addr;
            worker.parentNostrId = user.addr.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/)?.[0] || user.addr.match(/npub1[a-z0-9]+/i)?.[0];
            allWorkers.push(worker);
          });
        }
        allWorkers = allWorkers.filter(w => {
            if (!effectiveShowIdle && !w.active) return false;
            if (isFiltering) {
              const q = filterQuery.toLowerCase();
              // Check worker name and owner address
              if (w.name.toLowerCase().includes(q) || w.owner.toLowerCase().includes(q)) return true;
              // Check resolved Nostr profile name for owner
              const ownerNostrName = getNostrNameForAddr(w.owner);
              if (ownerNostrName && ownerNostrName.includes(q)) return true;
              // Check resolved Nostr profile name for worker (if worker name has nostr id)
              const workerNostrName = getNostrNameForAddr(w.name);
              if (workerNostrName && workerNostrName.includes(q)) return true;
              return false;
            }
            return true;
        });
        allWorkers.sort((a,b) => {
           if(a.active && !b.active) return -1;
           if(!a.active && b.active) return 1;
           return b.hps - a.hps;
        });
        let totalFlatHps = 0;
        allWorkers.forEach(w => totalFlatHps += w.hps);
        const totalHr = humanHashrateFromHps(totalFlatHps, 1);
        const $row = $("<div>").addClass("row");
        const $top = $("<div>").addClass("minerTop");
        const countTxt = allWorkers.length + (allWorkers.length === 1 ? " Worker" : " Workers");
        const countHtml = `
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:28px;height:28px;border-radius:50%;border:2px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;">
              <i class="fa-solid fa-hammer" style="font-size:11px;color:rgba(255,255,255,0.35);"></i>
            </div>
            <span>${countTxt}</span>
          </div>`;
        $top.append($("<div>").addClass("addr").html(countHtml).css("cursor","default"), $("<div>").addClass("totalHash").text(totalHr.value + " " + totalHr.unit));
        const $wrap = $("<div>").addClass("workersWrap");
        const $workers = $("<div>").addClass("workers");
        if (allWorkers.length > 0) allWorkers.forEach(w => $workers.append(createWorkerLine(w, w.name, w.owner, w.parentNostrId)));
        else $workers.append(isFiltering ? createNoMatchRow(filterQuery, true) : createEmptyWorkerLine());
        $wrap.append($workers);
        $row.append($top, $wrap);
        $list.append($row);
      }

      // Detect wrapped minerTop rows and add class for tighter spacing

      // Re-apply highlight if a row was being highlighted when re-render happened
      if (highlightedAddr && highlightStartTime) {
        const elapsed = Date.now() - highlightStartTime;
        const animDuration = 3000; // matches CSS animation duration
        if (elapsed < animDuration) {
          const row = document.querySelector(`.row[data-addr="${CSS.escape(highlightedAddr)}"]`);
          if (row) {
            row.classList.add('highlight-flash');
            row.addEventListener('animationend', function handler() {
              row.classList.remove('highlight-flash');
              row.removeEventListener('animationend', handler);
              highlightedAddr = null;
              highlightStartTime = null;
            });
          }
        }
      }
    }

    function timeSince(tsSec) {
      if (!isFinite(tsSec) || tsSec < 1672531200) return "> 1d ago";
      const now = Math.floor(Date.now() / 1000);
      const diff = now - tsSec;
      // if (diff < 5) return "just now";
      if (diff < 60) return diff + "s ago";
      if (diff < 3600) return Math.floor(diff / 60) + "m ago";
      if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
      return "> 1d ago";
    }

  function createWorkerLine(w, displayName, ownerAddr, parentNostrId){
      displayName = (!displayName || displayName === "unnamed") ? (ownerAddr ? ownerAddr : "worker") : displayName;

      const wh = humanHashrateFromHps(w.hps, 1);
if (["GH/s", "MH/s", "KH/s", "H/s"].includes(wh.unit)) {
  wh.value = Math.floor(parseFloat(wh.value)).toString();
}

      const status = w.active ? "active" : "idle";
      const lastTxt = isFinite(w.last) ? ("last share: " + timeSince(w.last)) : "last share: unknown";

      const $line = $("<div>").addClass("workerLine");
      const $left = $("<div>").addClass("workerLeft");
      const $dot = $("<span>").addClass("badgeDot").toggleClass("bad", !w.active);

      // MISSION CRITICAL: Priority ID Detection and Instant Linking
      const workerOwnUrl = extractUrl(displayName);
      const workerNostrId = displayName.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/)?.[0] || displayName.match(/npub1[a-z0-9]+/i)?.[0];
      const activeNostrId = workerNostrId || parentNostrId;

      // Check if parent is a Twitter handle
      const parentTwitterHandle = extractTwitterHandle(ownerAddr);
      const ownerUrl = extractUrl(ownerAddr) || extractCombinedUrl(ownerAddr, displayName);

      let myName = escapeHtml(displayName);
      if (workerOwnUrl) {
          // Worker has its own URL - this takes precedence over everything
          myName = `<a href="${escapeHtml(workerOwnUrl)}" target="_blank" rel="noopener noreferrer">${escapeHtml(displayName)}</a>`;
      } else if (activeNostrId && !parentTwitterHandle) {
          // Nostr ID (but not if parent is Twitter - Twitter takes precedence for inheritance)
          const hex = idToPubkey.get(activeNostrId);
          const npub = hex ? window.NostrTools.nip19.npubEncode(hex) : (activeNostrId.startsWith('npub1') || activeNostrId.includes('@') ? activeNostrId : null);
          if (npub) {
              myName = `<a href="https://primal.net/p/${encodeURIComponent(npub)}" target="_blank">${escapeHtml(displayName)}</a>`;
              getProfile(activeNostrId);
          }
      } else if (parentTwitterHandle) {
          // Inherit Twitter link from parent
          const cleanHandle = sanitizeTwitterHandle(parentTwitterHandle);
          const twitterUrl = `https://x.com/${encodeURIComponent(cleanHandle)}`;
          myName = `<a href="${escapeHtml(twitterUrl)}" target="_blank" rel="noopener noreferrer">${escapeHtml(displayName)}</a>`;
      } else {
          // No Nostr ID, no Twitter, no own URL - check for inherited URL from user/combined
          myName = linkifyName(displayName, ownerUrl);
      }

      const $name = $("<div>").addClass("workerName").html(myName);
      $left.append($dot, $name);

      const $right = $("<div>").addClass("workerRight");
      const $rate = $("<span>").text(wh.value + " " + wh.unit);
      const $last = $("<span>").addClass("lastBadge").text(lastTxt);

      if (isMobile()){
        if (w.active) $right.append($rate);
        else $right.append($rate, $last.addClass("showMobile"));
      } else $right.append($rate, $last);

      $line.append($left, $right);
      
      const b = humanHashrateFromHps(w.best || 0, 1);
      const best = window.innerWidth <= 375 ? "best" : "best share";
      const bestTxt = isFinite(w.best) ? (`${best}: ` + b.value + b.unit.replace(/H\/s/g, '')) : null;

      // let tooltipName = displayName;
      let tooltipName = escapeHtml(displayName);
      const ownerShort = ownerAddr ? smartTruncate(ownerAddr) : "";
      // if (ownerAddr && shortAddr(ownerAddr) !== displayName && ownerAddr !== displayName) tooltipName += " (" + ownerShort + ")";

      if (!$('#groupUsersCheck').is(':checked') && ownerAddr && shortAddr(ownerAddr) !== displayName && ownerAddr !== displayName) {
        tooltipName += " (" + escapeHtml(ownerShort) + ")";
      }

      // In grouped mode, don't pass parent's nostrId/ownerAddr (already visible inline), but DO pass workerName for worker's own URL
      const isGrouped = $('#groupUsersCheck').is(':checked');
      wireWorkerHover($line, { status: status, lastTxt: lastTxt, bestTxt: bestTxt, name: tooltipName, nostrId: isGrouped ? null : activeNostrId, ownerAddr: isGrouped ? null : ownerAddr, workerName: displayName });

      return $line;
    }

    function createEmptyWorkerLine(){
      const $line = $("<div>").addClass("workerLine");
      const $left = $("<div>").addClass("workerLeft");
      $left.append($("<span>").addClass("badgeDot bad"), $("<div>").addClass("workerName").text("— no workers found —"));
      return $line;
    }

    function createNoMatchRow(q, inline){
      const msg = "No matches for: " + q;
      if(inline) return $("<div>").addClass("workerLine").css({justifyContent:"center", opacity:0.7}).text(msg);
      return $("<div>").addClass("row").css({ textAlign:"center", padding:"18px 12px" }).text(msg);
    }

    /* =========================
        FILTER UI
    ========================= */

    function wireFilter(){
      function applyNow(){
        filterQuery = String($("#userFilter").val() || "").trim();
        $("#filterReset").prop("disabled", !filterQuery.length);
        renderUsersList(latestUserList);
      }
      $("#userFilter").on("input", () => { clearTimeout(filterTimer); filterTimer = setTimeout(applyNow, 80); });
      $("#userFilter").on("keydown", (e) => { if (e.key === "Escape"){ $("#userFilter").val(""); filterQuery = ""; $("#filterReset").prop("disabled", true); renderUsersList(latestUserList); } });
      $("#filterReset").on("click", () => { $("#userFilter").val(""); filterQuery = ""; $("#filterReset").prop("disabled", true); renderUsersList(latestUserList); });
      $("#showIdleCheck, #groupUsersCheck").on("change", () => renderUsersList(latestUserList));
    }

    /* =========================
        BOOT
    ========================= */

    let lastTrendAt = 0;

    async function refreshAll(forceTrend){
      await refreshOverview();
      await refreshUsersWorkersAndPie();
      const now = Date.now();
      if (forceTrend || (now - lastTrendAt > TREND_REFRESH_MS)){
        lastTrendAt = now;
        await refreshTrend();
      }
    }

    $(function(){
      initTrendChart();
      initMinersPie();
      setPieLegendForViewport();
      wireCopyFields();
      wireFilter();
      if (new URLSearchParams(window.location.search).get('group') === 'false') $("#groupUsersCheck").prop("checked", false);
      window.addEventListener("resize", setPieLegendForViewport);
      window.addEventListener("resize", () => renderUsersList(latestUserList));
      document.addEventListener("scroll", hideHoverTip, { passive: true });
      refreshAll(true);
      setInterval(() => refreshAll(false), FAST_REFRESH_MS);
    });

    function responsiveText() {
      const w = window.innerWidth;
      if (w <= 390) $('#users-workers').text('USERS');
      else if (w <= 490) $('#users-workers').text('WORKERS');
      else $('#users-workers').text('USERS + WORKERS');

      if (w < 500) $('#lbDiffHeader').text('Amount');
      else $('#lbDiffHeader').text('Difficulty');
    }
    window.addEventListener('resize', responsiveText);
    responsiveText();
  </script>
</body>
</html>
